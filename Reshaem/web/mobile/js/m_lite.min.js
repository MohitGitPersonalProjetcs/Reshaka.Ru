(function(a){var b=!1,c=[],d=function(){if(!b&&(b=!0,a.htmlNode=geByTag1("html"),a.bodyNode=geByTag1("body"),c)){for(var e=null;e=c.shift();)e.call(document);c=null}};document.addEventListener?document.addEventListener("DOMContentLoaded",function(){document.removeEventListener("DOMContentLoaded",arguments.callee,!1);d()},!1):document.attachEvent&&document.attachEvent("onreadystatechange",function(){"complete"===document.readyState&&(document.detachEvent("onreadystatechange",arguments.callee),d())});a.addEventListener?a.addEventListener("load",d,!1):a.attachEvent?a.attachEvent("onload",d):a.onload=d;a.onDOMReady=function(a){b?a.call(document):c.push(a)}})(window);if(!window._ua)var _ua=navigator.userAgent.toLowerCase();var browser={version:(_ua.match(/.+(?:me|ox|on|rv|it|era|ie)[\/: ]([\d.]+)/)||[0,"0"])[1],opera:/opera/i.test(_ua),msie:/msie/i.test(_ua)&&!/opera/i.test(_ua),msie6:/msie 6/i.test(_ua)&&!/opera/i.test(_ua),msie7:/msie 7/i.test(_ua)&&!/opera/i.test(_ua),msie8:/msie 8/i.test(_ua)&&!/opera/i.test(_ua),msie9:/msie 9/i.test(_ua)&&!/opera/i.test(_ua),mozilla:/firefox/i.test(_ua),chrome:/chrome/i.test(_ua),safari:!/chrome/i.test(_ua)&&/webkit|safari|khtml/i.test(_ua),iphone:/iphone/i.test(_ua),ipod:/ipod/i.test(_ua),iphone4:/iphone.*OS 4/i.test(_ua),ipod4:/ipod.*OS 4/i.test(_ua),ipad:/ipad/i.test(_ua),android:/android/i.test(_ua),bada:/bada/i.test(_ua),opera_mini:/opera mini/i.test(_ua),mobile:/iphone|ipod|ipad|opera mini|opera mobi|iemobile/i.test(_ua),msie_mobile:/iemobile/i.test(_ua),safari_mobile:/iphone|ipod|ipad/i.test(_ua),opera_mobile:/opera mini|opera mobi/i.test(_ua),mac:/mac/i.test(_ua)};browser.desktop=(browser.opera||browser.msie||browser.mozilla||browser.chrome||browser.safari)&&!browser.mobile;var isTouch="ontouchstart"in window;function isFunction(a){return"[object Function]"===Object.prototype.toString.call(a)}function isArray(a){return"[object Array]"===Object.prototype.toString.call(a)}function isObject(a){return"[object Object]"===Object.prototype.toString.call(a)}function escapeRE(a){return a?a.replace(/([.*+?^${}()|[\]\/\\])/g,"\\$1"):""}function htsc(a){return a.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/\'/g,"&#39;").replace(/%/g,"&#37;")}function escapeAttr(a){return a.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/\'/g,"&#39;")}function stripTags(a){return a.replace(/<[^>]+>/g,"")}function vkNow(){return+new Date}function intval(a){return!0===a?1:parseInt(a)||0}function qs2obj(a){if(!a)return{};for(var b={},a=a.toString().split("&"),c=0,d=a.length;c<d;c++){var e=a[c].split("=");e[0]&&(b[decodeURIComponent(e[0])]=decodeURIComponent(e[1]||""))}return b}function obj2qs(a){if(!a)return"";var b=[],c;for(c in a)b.push(encodeURIComponent(c)+"="+encodeURIComponent(a[c].toString()||""));return b.length?"?"+b.join("&"):""}function parseJSON(a){try{return JSON.parse(a)}catch(b){return eval("("+a+")")}}function lsSet(a,b){if("undefined"!==typeof b)try{return localStorage.setItem(a,b)}catch(c){}else try{return localStorage.removeItem(a)}catch(d){}return!1}function lsGet(a){try{return localStorage.getItem(a)}catch(b){}return!1}function ssSet(a,b){if("undefined"!==typeof b)try{return sessionStorage.setItem(a,b)}catch(c){}else try{return sessionStorage.removeItem(a)}catch(d){}return!1}function ssGet(a){try{return sessionStorage.getItem(a)}catch(b){}return!1}function getValues(a){if(!isArray(a))return a.call?a():a;for(var b=[],c=0,d=a.length;c<d;c++)b.push(getValues(a[c]));return b}function len(a){if(isArray(a))return a.length;if(isObject(a)){var b=0,c;for(c in a)b++;return b}return 0}(function(){var a=vkNow();window.clog=function(b){if(vk.__debug)try{if(window.console&&console.log){var c=Array.prototype.slice.call(arguments);c.unshift("["+(vkNow()-a)/1E3+"] ");browser.msie||browser.mobile?console.log(c.join(" ")):console.log.apply(console,c)}}catch(d){}}})();function each(a,b){var c,d=0,e=a.length;if("undefined"===typeof e)for(c in a){if(!1===b.call(a[c],c,a[c]))break}else for(c=a[0];d<e&&!1!==b.call(c,d,c);c=a[++d]);return a}function copy(a){return isArray(a)?a.concat([]):isObject(a)?extend({},a):a}var rf=function(){return!1};function addEvent(a,b,c){a=ge(a);c=c||rf;if(a&&!(3==a.nodeType||8==a.nodeType)){a.setInterval&&a!=window&&(a=window);for(var b=b.split(" "),d=0,e=b.length;d<e;d++){var f=b[d];a.addEventListener?a.addEventListener(f,c,!1):a.attachEvent&&a.attachEvent("on"+f,c)}}}function removeEvent(a,b,c){a=ge(a);c=c||rf;if(a&&!(3==a.nodeType||8==a.nodeType))for(var b=b.split(" "),d=0,e=b.length;d<e;d++){var f=b[d];a.removeEventListener?a.removeEventListener(f,c,!1):a.detachEvent&&a.detachEvent("on"+f,c)}}function cancelEvent(a){a=a||window.event;if(!a)return!1;a=a.originalEvent||a;a.preventDefault&&a.preventDefault();a.stopPropagation&&a.stopPropagation();a.cancelBubble=!0;return a.returnValue=!1}function checkEvent(a){return(a=a||window.event)&&("click"==a.type||"mousedown"==a.type||"mouseup"==a.type)&&(1<a.which||1<a.button||a.ctrlKey||a.shiftKey||a.metaKey)}function onCtrlEnter(a,b,c){b=b||window.event;if(10==b.keyCode||13==b.keyCode&&(b.ctrlKey||b.metaKey&&browser.mac))c.call(a),cancelEvent(b)}function submitBtn(a){if(!a)return!1;a=(a=a.form||gpeByTag("form",a))?geByClass("btn",a,"input"):!1;if(!a)return!1;for(var b in a){var c=a[b];if("submit"==c.type&&!c.name)break}return c}function parseCyr(a,b){for(var c=a,d="yo zh kh ts ch sch shch sh eh yu ya YO ZH KH TS CH SCH SHCH SH EH YU YA '".split(" "),e="\u0451\u0436\u0445\u0446\u0447\u0449\u0449\u0448\u044d\u044e\u044f\u0401\u0416\u0425\u0426\u0427\u0429\u0429\u0428\u042d\u042e\u042f\u044c".split(""),f=0,h=d.length;f<h;f++)c=b?c.split(d[f]).join(e[f]):c.split(e[f]).join(d[f]);f=0;for(h=48;f<h;f++)c=b?c.split("abvgdezijklmnoprstufhcyABVGDEZIJKLMNOPRSTUFHCY\u0451\u0401".charAt(f)).join("\u0430\u0431\u0432\u0433\u0434\u0435\u0437\u0438\u0439\u043a\u043b\u043c\u043d\u043e\u043f\u0440\u0441\u0442\u0443\u0444\u0445\u0446\u044b\u0410\u0411\u0412\u0413\u0414\u0415\u0417\u0418\u0419\u041a\u041b\u041c\u041d\u041e\u041f\u0420\u0421\u0422\u0423\u0424\u0425\u0426\u042b\u0435\u0415".charAt(f)):c.split("\u0430\u0431\u0432\u0433\u0434\u0435\u0437\u0438\u0439\u043a\u043b\u043c\u043d\u043e\u043f\u0440\u0441\u0442\u0443\u0444\u0445\u0446\u044b\u0410\u0411\u0412\u0413\u0414\u0415\u0417\u0418\u0419\u041a\u041b\u041c\u041d\u041e\u041f\u0420\u0421\u0422\u0423\u0424\u0425\u0426\u042b\u0435\u0415".charAt(f)).join("abvgdezijklmnoprstufhcyABVGDEZIJKLMNOPRSTUFHCY\u0451\u0401".charAt(f));return c==a?null:c}function parseLat(a){return parseCyr(a,!0)}function parseRusKeys(a,b,c){for(var d=a,e=b?"qwertyuiop[]asdfghjkl;'zxcvbnm,./`\u0435QWERTYUIOP{}ASDFGHJKL:\"ZXCVBNM<>?~\u0415":"\u0435\u0415",b=b?"\u0439\u0446\u0443\u043a\u0435\u043d\u0433\u0448\u0449\u0437\u0445\u044a\u0444\u044b\u0432\u0430\u043f\u0440\u043e\u043b\u0434\u0436\u044d\u044f\u0447\u0441\u043c\u0438\u0442\u044c\u0431\u044e.\u0451\u0451\u0419\u0426\u0423\u041a\u0415\u041d\u0413\u0428\u0429\u0417\u0425\u042a\u0424\u042b\u0412\u0410\u041f\u0420\u041e\u041b\u0414\u0416\u042d\u042f\u0427\u0421\u041c\u0418\u0422\u042c\u0411\u042e,\u0401\u0401":"\u0451\u0401",f=0,h=e.length;f<h;f++)d=c?d.split(e.charAt(f)).join(b.charAt(f)):d.split(b.charAt(f)).join(e.charAt(f));return d==a?null:d}function parseLatKeys(a,b){return parseRusKeys(a,b,!0)}function scrollTop(a,b){if("undefined"===typeof a)return htmlNode.scrollTop||bodyNode.scrollTop||window.scrollY||0;b?setTimeout(function(){window.scrollTo(0,Math.max(browser.android?1:0,a))},b):window.scrollTo(0,Math.max(browser.android?1:0,a))}function se(){var a=[],b=Array.prototype.slice.call(arguments);return function(c){if(c)if(c.apply)a.push(c);else if("__clear"===c)a=[];else{var d=Array.prototype.slice.call(arguments);d.shift();for(var e=0,f=a.length;e<f;e++)a[e].apply(window,getValues(b).concat(d))}}}window.onBodyScroll=se(scrollTop);window.onBodyResize=se();addEvent(window,"scroll touchmove",function(){onBodyScroll(!0)});addEvent(window,"error",function(a){console.log("line: "+a.lineno)});function initAutoScroll(a,b,c){a&&b&&onBodyScroll(function(d){var e=getValues(a);if(e){var f=getY(e),h=getCh();f-d-h<(c||h)&&b.call(e)}})}function autoScroll(a,b,c,d){var e=getValues(a),f=ge("show_more_loading"),h=function(){ajax.click(this,b,{use_cache:!c})};!e&&f&&h.call(f);initAutoScroll(a,h,d)}function scrollToEl(a,b,c){a=ge(a)||window;a=(a===window?1:getY(a))-(b||0);scrollTop(a,c)}function scrollToHash(a){a=a||nav.hash||location.hash;"#"===a[0]&&(a=a.substr(1));if(a){var b=geBySel("a[name]");!1===b&&(b=geByTag("a"));each(b,function(b,d){if(d.name==a)return scrollToEl(d),!1})}}function lockButton(a){a=ge(a);if("input"==tag(a)&&hasClass("btn",a)){var b=ce("button",{id:a.id,className:"locked"+(hasClass("sbtn",a)?" sbtn":""),innerHTML:"<span><b>"+(a.value||"")+"</b></span>",onclick:function(a){return cancelEvent(a)},real_btn:a});a.fake_btn=b;before(b,a);remove(a)}}function unlockButton(a){a=ge(a);a.real_btn?(before(a.real_btn,a),remove(a)):a.fake_btn&&(before(a,a.fake_btn),remove(a.fake_btn))}function extend(){var a=Array.prototype.slice.call(arguments),b=a.shift();if(!a.length)return b;for(var c=0,d=a.length;c<d;c++)for(var e in a[c])b[e]=a[c][e];return b}function ge(a){return"string"===typeof a?document.getElementById(a):a}function geByClass(a,b,c){b=ge(b)||document;c=c||"*";if(b.getElementsByClassName){b=b.getElementsByClassName(a);if("*"==c)return Array.prototype.slice.call(b);for(var d=[],c=c.toUpperCase(),a=0,e=b.length;a<e;a++)b[a].tagName.toUpperCase()==c&&d.push(b[a]);return d}b=geByTag(c,b);d=[];c=RegExp("(^|\\s)"+escapeRE(a)+"(\\s|$)");a=0;for(e=b.length;a<e;a++)c.test(b[a].className)&&d.push(b[a]);return d}function geByClass1(a,b,c){return geByClass(a,b,c)[0]}function gpeByClass(a,b){b=ge(b);if(!b)return null;for(;b=b.parentNode;)if(hasClass(a,b))return b;return null}function geByTag(a,b){return(ge(b)||document).getElementsByTagName(a)}function geByTag1(a,b){return geByTag(a,b)[0]}function gpeByTag(a,b){b=ge(b);if(!b)return null;for(a=a.toUpperCase();b=b.parentNode;)if(b.tagName.toUpperCase()==a)return b;return null}function geBySel(a,b){b=ge(b)||document;return b.querySelectorAll?b.querySelectorAll(a):!1}function geBySel1(a,b){b=ge(b)||document;return b.querySelector?b.querySelector(a):!1}function append(a,b){(b=ge(b))&&b.appendChild(ge(a))}function before(a,b){(b=ge(b))&&b.parentNode&&b.parentNode.insertBefore(ge(a),b)}function after(a,b){(b=ge(b))&&b.parentNode&&(b.nextSibling?b.parentNode.insertBefore(ge(a),b.nextSibling):b.parentNode.appendChild(ge(a)))}function remove(a){return(a=ge(a))&&a.parentNode?a.parentNode.removeChild(a):!1}function clone(a){return(a=ge(a))?a.cloneNode(!0):!1}function tag(a){a=ge(a);return(a&&a.tagName||"").toLowerCase()}function outer(a){a=ge(a);return!a?"":val(ce("div").appendChild(clone(a)).parentNode)}function show(a){if(a=ge(a))a.style.display=a.oldstyle||("span"==a.tagName.toLowerCase()?"inline":"block")}function hide(a){if(a=ge(a))"none"!=a.style.display&&(a.oldstyle=a.style.display),a.style.display="none"}function isVisible(a){a=ge(a);return!a||!a.style?!1:"none"!=a.style.display}function toggle(a,b){"undefined"===typeof b&&(b=!isVisible(a));(b?show:hide)(a)}function ce(a,b,c){a=document.createElement(a);b&&extend(a,b);c&&extend(a.style,c);return a}window.cdf=function(a){var b=a.createDocumentFragment(),c=a.createElement("div"),d=a.createRange&&a.createRange();b&&b.appendChild(c);d&&d.selectNodeContents&&d.selectNodeContents(c);return!b?function(a){return ce("div",{innerHTML:a})}:d&&d.createContextualFragment?function(b){return!b?a.createDocumentFragment():d.createContextualFragment(b)}:function(b){if(!b)return a.createDocumentFragment();c.innerHTML=b;for(b=a.createDocumentFragment();c.firstChild;)b.appendChild(c.firstChild);return b}}(document);function elfocus(a,b,c){a=ge(a);try{a.focus();if("undefined"===typeof b||!1===b)b=a.value.length;if("undefined"===typeof c||!1===c)c=b;if(a.createTextRange){var d=a.createTextRange();d.collapse(!0);d.moveEnd("character",b);d.moveStart("character",c);d.select()}else a.setSelectionRange&&a.setSelectionRange(b,c)}catch(e){}}function elblur(a){(a=ge(a))&&a.blur&&a.blur()}function val(a,b){if(a=ge(a)){var c=a.tagName.toLowerCase(),d="input"==c||"textarea"==c||"select"==c;if("undefined"===typeof b)return d?a.value:a.innerHTML;d?a.value=b:(a.innerHTML=b,"a"!=c&&(ajax.prepare_nav(a),ajax.prepare_click(a),ajax.onPrepared(!0,a)))}}function attr(a,b,c){if(a=ge(a)){if("undefined"===typeof c)return a.getAttribute&&a.getAttribute(b)||!1;if(!1===c)return a.removeAttribute&&a.removeAttribute(b)||!1;a.setAttribute&&a.setAttribute(b,c)}}function style(a,b,c){if((a=ge(a))&&a.style){if(isObject(b))return each(b,function(b,c){style(a,b,c)});var d="number"===typeof c;d&&/height|width/i.test(b)&&(c=Math.abs(c));a.style[b]=d&&!/z-?index|font-?weight|opacity|zoom|line-?height/i.test(b)?c+"px":c}}function hasClass(a,b){if(b=ge(b))return RegExp("(^|\\s)"+escapeRE(a)+"(\\s|$)").test(b.className)}function addClass(a,b){if((b=ge(b))&&!hasClass(a,b))b.className=(b.className?b.className+" ":"")+a}function removeClass(a,b){if(b=ge(b))b.className=(b.className||"").replace(RegExp("(^|\\s)"+escapeRE(a)+"(\\s|$)"),function(a,b,e){return b&&e?" ":""})}function toggleClass(a,b,c){("undefined"===typeof c?hasClass(a,b):!c)?removeClass(a,b):addClass(a,b)}function replaceClass(a,b,c){removeClass(a,c);addClass(b,c)}function getXY(a){a=ge(a);if(!a)return[0,0];var b=0,c=0;if(a.offsetParent){do b+=a.offsetLeft,c+=a.offsetTop;while(a=a.offsetParent)}return[b,c]}function getX(a){return getXY(a)[0]}function getY(a){return getXY(a)[1]}function getCw(){return Math.max(window.innerWidth||0,(window.htmlNode||{}).clientWidth||0)}function getCh(){return Math.max(window.innerHeight||0,(window.htmlNode||{}).clientHeight||0)}function evalJs(a){window.execScript?window.execScript(a):eval.call(window,a)}function alLoadingFix(a,b){var b=b||"al_loading",c=ge(b);if(c){if(!a)var d=ge("m").offsetHeight||0,e=ge("mfoot").offsetHeight||0,a=getCh()-d+e;c.style.height=a+"px";addClass(b,c)}}function getHref(a){if(!a)return!1;var b=!1;a.getAttribute&&(b=a.getAttribute("data-href")||a.getAttribute("href"));b||(b=a.pathname?a.pathname+a.search+a.hash:a);return b||!1}function ajx2q(a){var b=[],c=function(a){try{return encodeURIComponent(a)}catch(b){return a}},d;for(d in a)if(!(null==a[d]||isFunction(a[d])))if(isArray(a[d]))for(var e=0,f=0,h=a[d].length;e<h;++e)null==a[d][e]||isFunction(a[d][e])||(b.push(c(d)+"["+f+"]="+c(a[d][e])),++f);else b.push(c(d)+"="+c(a[d]));b.sort();return b.join("&")}function setNotify(a){var a=intval(a),b=geByTag1("a",geByClass1("btn notify","mhead")),c=geByClass1("pcont main");b&&(val(b,"<i></i>"+(0<a?"<em>"+a+"</em>":"")),0<a?removeClass("no_notify",b):addClass("no_notify",b),c&&(b=geByClass1("mail",geByClass1("main_menu",c)),geByTag1("a",b),b=geByTag1("span",b),c=geByTag1("em",b),0<a?c?val(c,a):append(ce("em",{innerHTML:a}),b):remove(c)))}function getNotify(){var a=geByTag1("a",geByClass1("btn notify","mhead"));return!a?0:intval(val(geByTag1("em",a)))}window.cur={};window.lang={};var geo={_def_opts:{enableHighAccuracy:!0,maximumAge:3E5,timeout:6E4},_provider:null,initW3C:function(){geo._provider=navigator.geolocation;geo.getCurrentPosition=function(a,b,c){geo._provider.getCurrentPosition(function(b){"undefined"!==typeof b.latitude?a(extend(b,{coords:extend(b.coords||{},{latitude:b.latitude,longitude:b.longitude})})):a(b)},b,c)}},initGears:function(){clog("initGears");geo._provider=google.gears.factory.create("beta.geolocation")},initSymbian:function(){clog("initSymbian");geo._provider=device.getServiceObject("Service.Location","ILocation");geo.getCurrentPosition=function(a,b){geo._provider.ILocation.GetLocation({LocationInformationClass:"BasicLocationInformation"},function(c,d,e){4==d?b({code:2,message:"Position unavailable"}):a({timestamp:null,coords:{latitude:e.ReturnValue.Latitude,longitude:e.ReturnValue.Longitude,altitude:e.ReturnValue.Altitude,heading:e.ReturnValue.Heading}})})}},initPalm:function(){clog("initPalm");geo.getCurrentPosition=function(a,b,c){var d={};c&&(c.enableHighAccuracy&&!0==c.enableHighAccuracy&&(d.accuracy=1),c.maximumAge&&(d.maximumAge=c.maximumAge),c.responseTime&&(5>c.responseTime?d.responseTime=1:20>c.responseTime?d.responseTime=2:d.timeout=3));new Mojo.Service.Request("palm://com.palm.location",{method:"getCurrentPosition",parameters:d,onSuccess:function(b){a({timestamp:b.timestamp,coords:{latitude:b.latitude,longitude:b.longitude,heading:b.heading}})},onFailure:function(a){1==a.errorCode?b({code:3,message:"Timeout"}):2==a.errorCode?b({code:2,message:"Position unavailable"}):b({code:0,message:"Unknown Error: webOS-code"+errorCode})}})}},getCurrentPosition:function(a,b,c){geo._provider.getCurrentPosition(a,b,extent(geo._def_opts,c||{}))},init:function(){try{if("undefined"!==typeof navigator.geolocation)geo.initW3C();else if("undefined"!==typeof window.google&&"undefined"!==typeof google.gears)geo.initGears();else if("undefined"!==typeof device&&"undefined"!==typeof device.getServiceObject)geo.initSymbian();else if("undefined"!==typeof Mojo&&"Mojo.Service.Request"!==typeof Mojo.Service.Request)geo.initPalm();else return!1}catch(a){return!1}return!0}},ajax={_init:function(){try{new XMLHttpRequest&&(ajax._req=function(){return new XMLHttpRequest})}catch(a){try{new ActiveXObject("Msxml2.XMLHTTP")&&(ajax._req=function(){return new ActiveXObject("Msxml2.XMLHTTP")})}catch(b){try{new ActiveXObject("Microsoft.XMLHTTP")&&(ajax._req=function(){return new ActiveXObject("Microsoft.XMLHTTP")})}catch(c){ajax._req=!1}}}},_getreq:function(){ajax._req||ajax._init();return ajax._req()},_al_reqs:[],_last_req:null,save_req:function(a){ajax._al_reqs.push(a||ajax._last_req)},abort_reqs:function(){var a=[];each(ajax._al_reqs,function(b,c){a.push(c.readyState);4>c.readyState&&c.abort()});ajax._al_reqs=[];clog(a)},plainpost:function(a,b,c,d,e){var f=ajax._last_req=ajax._getreq(),b="string"!=typeof b?ajx2q(b):b;f.onreadystatechange=function(){4==f.readyState&&(200<=f.status&&300>f.status?c&&c(f.responseText,f):d&&d(f.responseText,f))};try{f.open("POST",a,!0)}catch(h){return!1}e||(f.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),f.setRequestHeader("X-Requested-With","XMLHttpRequest"));f.send(b);return f},post:function(a,b,c){"/"!=a.substr(0,1)&&(a="/"+a);return ajax._post(a,b,c||{})},onPrepared:se(),prepare_click:function(a){if(isTouch&&window.al&&al.ver){var b=[],c=!1;a&&"a"==(a.tagName||"").toLowerCase()?b.push(a):isArray(a)?b=a:(b=geByTag("a",a),c=!0);if(b[0]&&b[0].getAttribute)for(var a=0,d=b.length;a<d;a++){var e=b[a];if((!c||e.getAttribute("onclick")&&!e.getAttribute("data-href"))&&null!=e.getAttribute("href"))e.setAttribute("data-href",getHref(e)),e.removeAttribute("href")}}},click:function(a,b,c){var b=b||{},d=!1,e={_ajax:1},f=extend(b,{link:a}),c=c||{};if(c.use_cache){var h=ge(!0===c.use_cache?"preload_data":c.use_cache),e=h.innerHTML.replace(/(^<\!--|--\>$)/g,""),i=e.split("--\><\!--");e?(h.innerHTML="",b.onStart&&b.onStart.apply(f),c.nav&&nav.go(d,null,{push_only:!0}),b.onDone&&b.onDone.apply(f,i),(a=geByClass1("show_more",geByClass1("pcont","mcont")))&&ajax.click(a,{onDone:function(){var a="";each(arguments,function(b,c){a+="<\!--"+(c||"")+"--\>"});h.innerHTML=a;ge("show_more_loading")&&ajax.click(!1,b,c)}})):(b.onStart&&b.onStart.apply(f),c.nav&&nav.go(d,null,{push_only:!0}));return!1}if(!a)return!0;if(a.form){var i=a.form,k={},d=(i.action||"").replace(/^https?:\/\/[^\/]+/i,"");each(i,function(b,c){if(!c.name||c.disabled||"radio"===c.type&&!c.checked||"checkbox"===c.type&&!c.checked||"button"===c.type||"submit"===c.type&&c!==a||"image"===c.type&&c!==a)return!0;k[c.name]=c.value});!i.method||"get"==i.method?d=d.split("?",1).shift()+obj2qs(k):extend(e,k)}else a.getAttribute&&(d=a.getAttribute("data-href")||a.getAttribute("href"));d||(d=a.pathname?a.pathname+a.search+a.hash:a);if(!d)return!0;extend(e,c.url_params||{});if(e=ajax.post(d,e,{onDone:function(){c.lock&&unlockButton(a);b.onDone&&b.onDone.apply(f,arguments);(c.nav||c.scroll)&&scrollToHash()},onFail:function(){c.lock&&unlockButton(a);b.onFail&&b.onFail.apply(f,arguments);(c.nav||c.scroll)&&scrollToHash()}}))b.onStart&&b.onStart.apply(f),c.nav&&nav.go(d,null,{push_only:!0}),c.lock&&lockButton(a);return!e},prepare_nav:function(a){if(window.al&&al.ver){var b=[],c=!1;a&&"a"==tag(a)?b.push(a):isArray(a)?b=a:(b=geByTag("a",a),c=!0);for(var d=0,e=b.length;d<e;d++){var f=b[d];addEvent(f,"touchstart",thover.start);if(!c||!attr(f,"onclick")&&attr(f,"href")){var h=f.hostname||(/^(https?:)\/\/([^:\/]+)?(?::(\d+))?\/?(.*)$/i.exec(f.href)||[])[2];"_blank"!==f.target&&h==location.hostname&&attr(f,"onclick","return nav.go(this, event);")}}a=geByTag("input",a);d=0;for(e=a.length;d<e;d++)b=a[d],b.form&&("submit"==b.type&&!b.getAttribute("onclick"))&&b.setAttribute("onclick","return nav.go(this, event);")}},nav:function(a,b){b=b||{};b.nav=b.nav||{};var c=getHref(a),d,e=page.getHash(b.nav);if(!(c=nav.checkUrl(c)))return!1;"/"!=c.substr(0,1)&&(c="/"+c);menu.close(null,!0);if(b.need_restore&&b.nav.push&&page.restore(e))return ajax.abort_reqs(),nav.set(b),!0;var f=!1,h=!1;if(b.fast)f=!0,page.set(e,!1,{before:!0,beforeAppend:b.beforeAppend,afterAppend:b.afterAppend});else if(b.target&&b.target.className){var i=(d=/(?:^|\s)(al_([a-z_]+)(-?[0-9]+)?)(?:\s|$)/i.exec(b.target.className))&&d[1]||!1,k=d&&d[2]||!1,g;switch(k){case "menu":f=!0;page.set(e,!1,{before:!0,beforeAppend:function(a){val(geByClass1("mcont",a),'<div class="pcont"><div id="al_loading"></div></div>');var c=b.target.getAttribute("data-header")||"",j=geByClass1("mhead",a);geByClass1("btn logo",j)?val(j,""+(window.al&&window.al.menu?'<div class="btn home"><a href="/" class="b" accesskey="*" onclick="return menu.toggle(event);"><i></i></a></div>':'<div class="btn home vk_home"><a href="/" class="b" accesskey="*"><i></i></a></div>')+'<div class="btn notify">'+val(geByClass1("btn notify",a))+'</div><div class="btn back"><div class="b"><div class="title"><h1>'+(c||"&nbsp;")+"</h1></div></div></div>"):c&&val(geByClass1("btn back",a),'<div class="b"><div class="title"><h1>'+c+"</h1></div></div>")},afterAppend:function(){alLoadingFix();scrollTop(0)}});break;case "tab":f=!0;page.set(e,!1,{before:!0,beforeAppend:function(a){hasClass("_thide",b.target)&&each(geByClass("_hide",a),function(a,b){hide(b)});val(geByClass1("upanel",a),'<div id="al_loading"></div>');var c=geByClass1("tabs",a),j=geByClass1("active",c);j&&(removeClass("cur",geByClass1("cur",c)),addClass("cur",j.parentNode));(g=b.target.getAttribute("data-header"))&&val(geByClass1("btn back",a),'<div class="b"><div class="title"><h1>'+g+"</h1></div></div>")},afterAppend:function(){alLoadingFix()}},b);break;case "post":f=!0;page.set(e,!1,{before:!0,beforeAppend:function(a){var c=clone(gpeByClass("post",b.target)),j=c.id,d,e=outer(gpeByTag("a",geByClass1("u",c,"img"))),f=gpeByTag("div",geByClass1("author",c)),g=remove(geByClass1("date",c)),s=outer(remove(geByClass1("explain",f))),f=outer(f),c=geByClass1("cc",c),n=geByClass1("more",c),r=geByClass1("info",c),h=geByClass1("links",c),i=geByClass1("replies_link",h),r=val(remove(geByClass1("replies",r)))?val(i):lang.mobile_wall_post_replies_title,i=i?'<a name="comments"></a><h5>'+(r||"")+'</h5><div id="al_loading"></div>':"";n&&(n.nextSibling.style.display="inline",n.style.display="none");val(h,outer(geByClass1("like_wrap",c)));(d=b.target.getAttribute("data-header"))&&val(geByClass1("btn back",a),'<div class="b"><div class="title"><h1>'+d+"</h1></div></div>");d=val;a=geByClass1("mcont",a);g=val(g);c=val(c);d(a,'<div class="pcont wall"><div class="panel">'+(e||"")+'<div class="cont">'+(f||"")+'<div class="info"><span class="date">'+(g||"")+'</span></div></div></div><div id="'+(j||"")+'" class="post one"><div class="cont"><div class="ch">'+(s||"")+'</div><div class="cc">'+(c||"")+"</div></div></div>"+(i||"")+"</div>")},afterAppend:function(a){(a=geByTag1("h5",a))&&alLoadingFix(b.nav.hash?getCh()-a.offsetHeight:0);b.nav.hash?scrollToHash(b.nav.hash):scrollTop(0)}},b);break;case "pinfo":f=!0;page.set(e,!1,{before:!0,beforeAppend:function(a){var b=geByClass1("pcont",a),c=geByClass1("panel",a),d=geByClass1("u",c,"img"),e=geByTag1("h2",c),f=geByTag1("b",e),g=geByClass1("lv",c),s=ce("div");addClass("prof_finfo",b);val(c,'<img src="'+attr(d,"src")+'" class="u" align="left"><div class="cont"><h2>'+stripTags(val(e))+'</h2><div class="lvl">'+(f?lang.mobile_online:val(g))+'</div></div><div class="cb"></div>');each(geByClass("_pinfo",a),function(a,b){s.appendChild(b)});val(geByClass1("upanel",a),"<div>"+val(s)+'</div><div id="al_loading"></div>')},afterAppend:function(){alLoadingFix();scrollTop(0,10)}},b);break;case "player":f=!0;page.set(e,!1,{before:!0,beforeAppend:function(a){var b=audio.playlist(),c=audio.playlist_q(),b=((b[0]||{}).id||"").split("_").slice(2).join("_")||"",d=nav.path+(nav.params?"?"+nav.params:"");val(geByClass1("btn back",a),'<a class="b al_back" data-href="'+d+'" onclick="return nav.go(this, event);"><i>&nbsp;</i><div class="title"><h1>'+lang.mobile_menu_player_head_title+"</h1></div></a>");val(geByClass1("mcont",a),'<div class="pcont audios"><div class="panel np"><form action="/audio" class="oneline qsearch"><input type="hidden" name="act" value="player"><input type="hidden" name="list" value="'+escapeAttr(b)+'"><table><tr><td width="100%"><div class="iwrap"><input id="qsearch_fld" type="text" class="text" name="q" placeholder="'+lang.mobile_audio_search_placeholder+'"></div></td><td class="last"><input id="qsearch_btn" class="btn" type="submit" value="'+lang.mobile_audio_search_btn+'" /></td></tr></table></form></div><div class="upanel"><div class="audios_wrap audios_list" data-query="'+escapeAttr(c)+'"></div></div></div>');val("m",a.innerHTML)}},b);h=function(){var a=audio.playlist(),b=((a[0]||{}).id||"").split("_").slice(2).join("_")||"",b="/audio"+obj2qs({act:"player",list:b}),c=[],d={};each(a,function(a,b){c.push(b.id);d[b.id]=[b.artist+" "+b.title,b.id,b.src,b.artist,b.title,b.dur,b.can_add,!1]});qsearch.init({action:b,al_action:b,container:geByClass1("upanel","mcont"),field:ge("qsearch_fld"),btn:ge("qsearch_btn"),top_items:c,_cache:d,hl_fields:[2,3],tpl:function(a,b,c,d){return b?d?d:""==d?'<div class="audio_wrap audios_list" data-query="'+escapeAttr(b)+'">'+a+"</div>":'<div class="audio_wrap audios_list" data-query="'+escapeAttr(b)+'"><div class="al_loading qs_loading">&nbsp;</div></div>':'<div class="audio_wrap audios_list" data-query="'+escapeAttr(audio.playlist_q())+'">'+a+"</div>"},item_tpl:function(a,b,c,d,j,e,f){return audioplayer&&audioplayer.getDOMFromAudio({id:a,src:b,dur:j,artist:c,title:d,can_add:e,can_del:f},!0,this.q)||""},null_tpl:function(a){return'<div class="m"><div class="null">'+(a?lang.mobile_audio_search_not_found.replace("%s",htsc(a)):lang.mobile_audio_no_audio)+"</div></div>"},soft_filter:!0,need_invalid_keys:browser.desktop,top_len:50,global_search:!0,onRendered:function(){audioplayer&&audioplayer.initAudio()},al_need:!0,init_offset:0});a=audio.getCurrentId();if(a=ge("audio"+a))a=getY(a)+a.offsetHeight/2-getCh()/2,scrollTop(a)};break;case "photo":f=!0;page.set(e,!1,{before:!0,beforeAppend:function(a){var c=geByTag1("img",b.target),d=c&&c.src||"/images/blank.gif",e="",f="",m=(attr(c,"data-photo")||"").split("|"),g=m[0],s=+m[1]||0,m=+m[2]||0,n=!0;if(!s||!m)s=c&&c.width||0,m=c&&c.height||0,n=!1;if(g){if(s&&m)var c=Math.min(604,getCw())/s,r=Math.min(604,Math.ceil(1<=c&&n?m:m*c)),e=e+("height:"+r+"px;");e+="background:url("+d+") #f7f7f7 no-repeat center top;";100<r&&each(["-moz-","-o-","-webkit-",""],function(a,b){e+=b+"background-size:contain;"});d=g}else f+="width:100%;";val(geByClass1("btn back",a),'<div class="b"><i>&nbsp;</i><div class="title"><h1>'+lang.mobile_photos_photo_head_title+"</h1></div></div>");val(geByClass1("mcont",a),'<div class="pcont photoview"><div class="summary">&nbsp;<div class="loading" style="float:left;"><i></i></div></div><div class="photo_wrap"><div class="pv" style="'+(e||"")+'"><img src="'+d+'" alt="" style="'+(f||"")+'" /></div></div><div id="al_fill"></div></div>')},afterAppend:function(){alLoadingFix(0,"al_fill");scrollTop(0)}},b);break;case "u":case "g":case "p":case "e":f=!0;page.set(e,!1,{before:!0,beforeAppend:function(a){var c,d=i.substr(2),e=geByClass1(d,a,"a")||geByClass1(d,a,"span"),e=stripTags(attr(b.target,"data-name")||attr(e,"data-name")||val(e)||""),d=(d=geByClass1(d,a,"img"))&&d.src||attr(b.target,"data-photo")||"/images/blank.gif",f=geByClass1("mhead",a);"u"==k?c=e.split(" ").shift():"g"==k?c=lang.mobile_group_head_title:"p"==k?c=lang.mobile_public_head_title:"e"==k&&(c=lang.mobile_event_head_title);geByClass1("btn logo",f)?val(f,""+(window.al&&window.al.menu?'<div class="btn home"><a href="/" class="b" accesskey="*" onclick="return menu.toggle(event);"><i></i></a></div>':'<div class="btn home vk_home"><a href="/" class="b" accesskey="*"><i></i></a></div>')+'<div class="btn notify">'+val(geByClass1("btn notify",a))+'</div><div class="btn back"><div class="b"><div class="title"><h1>'+(c||"&nbsp;")+"</h1></div></div></div>"):c&&val(geByClass1("btn back",a),'<div class="b"><div class="title"><h1>'+c+"</h1></div></div>");val(geByClass1("mcont",a),'<div class="pcont prof"><div class="panel prof_panel"><img src="'+(d||"")+'" class="u" align="left"><div class="cont"><h2>'+(e||"")+'<h2/></div></div><div id="al_loading"></div>')},afterAppend:function(){alLoadingFix();scrollTop(0)}},b);break;default:cur.al_fast&&cur.al_fast[k]&&(f=!0,page.set(e,!1,cur.al_fast[k](b),b))}}f&&nav.set(b);ajax.abort_reqs();b.local?(c=!0,page.set(e,{},{after:!0,no_scroll:!0,force:!0},!1),h&&h()):(c=ajax._post(c,b.params||{},{onPageDone:function(a,c,d,q){page.set(e,{title:a,html:c,js:d,lm:q},{after:f,no_scroll:f},f?!1:b);menu.refresh(q)}}),ajax.save_req());return c},confirm:function(a,b,c,d){return confirm(b)?ajax.click(a,d,{url_params:{hash:c}}):!1},_post:function(a,b,c){var d=function(a,b){c.onFail&&c.onFail.call(window,0,a,b)};return ajax.plainpost(a,b,function(b){var f=!1;try{f=parseJSON(b)}catch(h){f=!1}if(!1===f)d();else{var i=f.shift(),k=f.shift(),b=f.shift(),i=window.al&&i!=al.ver||!menu.refreshCounters(k);!1!==k&&setNotify(k[2]);switch(b){case 0:if(i)return nav.hard_go(nav.cur,null,{replace:!0});b=f.shift();c.onDone&&(isArray(f)?c.onDone.apply(window,b):c.onDone.call(window,b));break;case 1:k=f.shift();f=f.shift();i||f?nav.hard_go(k):nav.go(k);break;case 2:k=f.shift();c.onFail?(f.unshift(k),f.unshift(b),c.onFail.apply(window,f)):nav.hard_go(k);break;case 3:page.need_hard_go=i,c.onPageDone||(c.onPageDone=function(b,c,d,e){nav.go(a,null,{push_only:!0});page.set(page.getHash(nav),{title:b,html:c,js:d,lm:e});menu.refresh(e)}),c.onPageDone.apply(window,f)}}},d)}},thover={obj:null,highlight:!1,start:function(a){thover.clear();thover.end(a);thover.obj=this||null;thover.obj&&(thover.highlight=!0,addClass("hover",thover.obj))},cancel:function(a){thover.obj&&(thover.highlight=!1,thover.end(a))},end:function(){thover.obj&&(removeClass("hover",thover.obj),thover.highlight&&(thover.clear(),addClass("active",thover.obj)),thover.obj=null,thover.highlight=!1)},clear:function(){removeClass("active",geByClass1("active","m"))}};addEvent(document,"touchmove touchcancel",thover.cancel);addEvent(document,"touchend",thover.end);function fixHeight(){if(browser.safari_mobile||browser.android||browser.opera_mobile&&!browser.opera_mini){getCh();var a=scrollTop();bodyNode.style.overflow="hidden";bodyNode.style.minHeight="5000px";scrollTop(10);var b=getCh()+1;scrollTop(a);bodyNode.style.minHeight=b+"px";bodyNode.style.overflow="auto"}}var page={fast_load:!1,need_hard_go:!1,getHash:function(a){return"#player"==a.hash?!1:a.path+(a.params?"?"+a.params:"")},getAlias:function(a){if(!a)return!1;var b=(a||"").split("?"),a=b[0],b=qs2obj(b[1]);delete b.from;delete b.offset;return a+obj2qs(b)},set:function(a,b,c,d){var c=c||{},e=scrollTop(),f=null;c.force||(f=remove("m"));if(!c.after&&(clog("st "+e),!page.fast_load)){var h=page.getHash(nav);page.save(h,{html:null,st:e,page:f,state:page.stash()},!0)}c.before||page.clear();if(c.before||!c.before&&!c.after)window.lm_qsearch_counter?lm_qsearch_counter++:lm_qsearch_counter=1;if(c.before)page.fast_load=!0,d&&d.target&&addClass("__al_target",d.target),b=f.cloneNode(!0),d&&d.target&&removeClass("__al_target",d.target),d=geByClass1("__al_target",b),removeClass("__al_target",d),c.beforeAppend&&c.beforeAppend(b,d),append(b,"vk_wrap"),cur.toggleHeaderSearch&&cur.toggleHeaderSearch(!1),c.afterAppend&&c.afterAppend(b);else{d&&nav.set(d);if(page.need_hard_go)return nav.hard_go(nav.cur,null,{replace:!0});c.force||(b.title&&(document.title=b.title),f=b.page,f||(f=ce("div",{id:"m"}),val(f,b.html)),menu.opened()&&(h=ce("div",{id:"m_helper",onclick:menu.close}),append(h,f)),append(f,"vk_wrap"));page.fast_load=!1;thover.clear();c.force||(b.js&&evalJs(b.js),b.state&&page.stash(b.state),page.save(a,b));d=d?d.nav&&d.nav.hash:nav.hash;b.st||!d?scrollTop(b.st||0,10):c.no_scroll&&!c.force?scrollTop(e,10):scrollToHash();audioplayer&&audioplayer.initAudio()}},save:function(a,b,c){if(a){var d=c?nav.page_get(a):{};d&&(nav.page_set(a,extend(d,b),page.getAlias(a)),clog((c?"add ":"set ")+a))}},restore:function(a){var b=nav.page_get(a);b||(b=nav.page_get(page.getAlias(a)));return b?(page.set(a,b),b.lm&&b.lm.fv_link&&menu.refresh({fv_link:b.lm.fv_link}),clog("get "+a),clog("scrolled to "+b.st),!0):!1},stash:function(a){return window.cur&&cur.stash&&cur.stash(a)||!1},clear:function(){onBodyScroll("__clear");onBodyResize("__clear");window.cur&&cur.destroy&&cur.destroy();window.cur={}}},nav=function(){function a(a){var b;if(b=/^(https?:)\/\/([^:\/]+)?(?::(\d+))?\/?(.*)$/i.exec(a)){if(b[1]!=location.protocol||b[2]&&b[2]!=location.hostname||b[3]&&b[3]!=location.port)return!1;a=b[4]}return a}function b(a,b,c){if(b||c&&c.push_only)return!0;c&&c.replace?location.replace(a):location.href=a;return!0}function c(a,c,d){cancelEvent(c);a=getHref(a);if(window.al&&al.ver&&(d&&d.push_only||ajax.nav(a,d)))return!0;b(a,c,d)}function d(b,d,f){f=extend({no_push:!1,push_only:!1,replace:!1},f);if(checkEvent(d)||!b)return!0;var p=b,m="",g="",s="";!b.href&&b.getAttribute&&(p=b.getAttribute("data-href"));if(("input"==tag(b)||"button"==tag(b))&&"submit"==b.type&&b.form){var n=b.form,r={};if(!(p=a(n.action||"")))return!0;each(n,function(a,c){if(!c.name||c.disabled||"radio"===c.type&&!c.checked||"checkbox"===c.type&&!c.checked||"button"===c.type||"submit"===c.type&&c!==b||"image"===c.type&&c!==b)return!0;r[c.name]=c.value});!n.method||"get"==n.method?p=p.split("?",1).shift()+obj2qs(r):f.params=r;clog(n.method);clog(p);clog(obj2qs(f.params))}if("string"!==typeof p)m=p.pathname,"/"!==m.substr(0,1)&&(m="/"+m),g=p.search.substr(1),s=p.hash,p=m+p.search+s;else if(m=p.split("#"),n=m.shift(),s=m.length?"#"+m.join("#"):"",n=n.split("?"),m=n.shift(),g=n.join("?"),(s||g)&&!m)m=nav.path,n||(g=nav.params),p=m+(g?"?"+g:"")+s;d&&(p.split("#").shift()==nav.cur.split("#").shift()&&s)&&(scrollToHash(s),f.push_only=!0);if(f.no_push&&nav.cur==p)return!1;if(f.push_only)return e(extend(f,{nav:{push:p,path:m,params:g,hash:s}})),!1;addClass("active",f.link||b);hasClass("al_back",b)&&(f.need_restore=!0);d=extend(f,b.tagName?{target:b}:{},{nav:{push:p,path:m,params:g,hash:s}});cur.processNav&&cur.processNav(d)?(e(d),menu.close(null,!0)):c(d.nav.push,null,d);return!1}function e(a){if(!a.no_push&&nav.cur!=a.nav.push)try{var c=a.nav.push;if(h)a.replace?history.replaceState(null,null,c):history.pushState(null,null,c),clog(a.replace?"replace: "+c:"push: "+c);else{var d="/"==c.substr(0,1)?c:"/"+c;ge("base").href=d;a.replace?location.replace(location.pathname+location.search+"#"+d):(i=d,location.hash=d);clog(a.replace?"replace hash: "+c:"push hash: "+c)}}catch(e){return b(a.nav.push,null,a)}nav.cur=a.nav.push;nav.path=a.nav.path;nav.params=a.nav.params;nav.hash=a.nav.hash}function f(){var a=(location.hash||"").substr(1);i!==a&&(i=a,k(!0));setTimeout(f,100)}var h=!(!window.history||!history.pushState),i=null,k=se(function(){return i}),g=[];if(h)addEvent(window,"popstate",function(){clog("popstate: "+location.href);d(location,null,{no_push:!0,need_restore:!0})});else{var v=location.hash||"";"#/"==v.substr(0,2)&&b(v.substr(1),null,{replace:!0});"onhashchange"in window?addEvent(window,"hashchange",function(){var a=(location.hash||"").substr(1);a||(a=location);d(a,null,{no_push:!0,need_restore:!0})}):(f(),k(function(a){clog("popstate hash: "+a);d(a,null,{no_push:!0,need_restore:!0})}))}return{go:d,al_go:c,app_go:function(a,b,c){if(!c||checkEvent(b))return!0;remove("app_go_frame");var d=getHref(a),a=ce("iframe",{id:"app_go_frame",src:c,onload:function(){remove("app_go_frame");d&&nav.hard_go(d)}},{display:"none"});bodyNode.appendChild(a);return!1},hard_go:b,page_set:function(a,b,c){clog("SET","hash:",a,"alias:",c);for(var d=g.length-1;0<=d;--d)if(g[d].h==a||g[d].a==a){g[d]={h:a,d:b,a:c};return}g.push({h:a,d:b,a:c});4<g.length&&g.shift()},page_get:function(a){clog("GET","hash:",a);for(var b=g.length-1;0<=b;--b)if(g[b].h==a||g[b].a==a)return g=g.slice(0,b+1),clog("found","hash:",g[b].h,"alias:",g[b].a),g[b].d;return!1},set:e,checkUrl:a,cur:location.pathname+location.search+location.hash,path:location.pathname,params:location.search.substr(1),hash:location.hash}}();ajax._init();ajax.enabled=ajax._req?!0:!1;ajax.enabled&&(onDOMReady(function(){remove("app_go_frame");ajax.prepare_nav();ajax.prepare_click();menu&&menu.initTouch();audioplayer&&audioplayer.initAudio()}),page.clear());addEvent(window,"orientationchange",fixHeight);onDOMReady(fixHeight);var Like={onDone:function(a,b,c,d){var e=ge(a)||geByClass1("like_box");if(e&&a){geByClass1("info",e);var a=geByClass1("like",e),f=geByClass1("repost",e),e=geByClass1("like_wrap",e);a&&(a.innerHTML=b||"",toggle(a,b));f&&(f.innerHTML=c||"",toggle(f,c));e&&val(e,d||"")}},onFail:function(){var a=Array.prototype.slice.call(arguments);switch(a.shift()){case 2:nav.hard_go(a[0])}}},PhotoLike={onDone:function(a,b,c,d){Like.onDone.apply(this,arguments);if(this.photo_id){var e=photo.get(this.photo_id);if(e){e.likes='<span class="like">'+b+"</span>";e.publish='<span class="repost">'+c+"</span>";var f=ce("div",{innerHTML:e.actions}),h=geByClass1("like_wrap",f);val(h,d);e.actions=val(f);photo.save(e)}}},onFail:Like.onFail},PhotoTag={onDone:function(){if(this.photo_id){var a=photo.get(this.photo_id);a&&(a.tag_info="",photo.save(a));a=geByClass1("photoview");a=geByClass1("tag_info_wrap",a);val(a,"")}}},Poll={onDone:function(a,b){val(a,b)}},ToggleMenu={onStart:function(){addClass("loading",this.link)},onDone:function(a){this.link&&val(this.link.parentNode,a)}},Wall={onStart:function(){var a=gpeByClass("show_more_wrap",this.link)||this.link,b=ce("div",{id:"show_more_loading",className:"show_more_loading",innerHTML:"<i>&nbsp;</i>"}),c=ce("div",{id:"show_more_wrap",className:"show_more_wrap"});attr(b,"data-href",getHref(a));c.appendChild(b);before(c,a);remove(a)},onDone:function(a){var b=ge("show_more_wrap"),a=cdf(a);before(a,b);remove(b);ajax.prepare_nav("mcont");ajax.prepare_click("mcont");onBodyScroll(!0)}},Photos={onStart:Wall.onStart,onDone:function(a,b){var c=geByClass1("pv_all",geByClass1("photos","mcont")),d=ge("show_more_wrap"),e=cdf(b),a=a.replace(/<img src="([^"]+)"/gi,'<img data-src="$1" class="_i"'),f=cdf(a);c&&c.appendChild(f);before(e,d);remove(d);ajax.prepare_nav("mcont");ajax.prepare_click("mcont");setTimeout(function(){onBodyScroll(!0)},100)}},Audios={onStart:Wall.onStart,onDone:function(a,b){var c=geByClass1("audios_wrap",geByClass1("audios","mcont")),d=ge("show_more_wrap"),e=cdf(b),f=cdf(a);c&&c.appendChild(f);before(e,d);remove(d);ajax.prepare_nav("mcont");ajax.prepare_click("mcont")}},FixPost={onDone:function(a){val(this.link.parentNode,a)}},Notify={onStart:function(){for(var a=this.link;a=a.parentNode;)if(hasClass("notify",a)){hasClass("notify_panel",a.parentNode)?remove(a.parentNode):remove(a);break}}},Dialog={onStart:function(){var a=geByClass("pages","mcont");each(a,function(a,c){before(ce("div",{className:"loading",innerHTML:"<i></i>"}),c.firstChild)})},onDone:function(a,b){var c=ge("messages"+b);c&&(val(c,a),!this.save&&scrollToEl());this.save&&mail.saveDialog({messages:a},this.save);this.clear&&(val(geByTag1("textarea","write_form"),""),remove(geByClass1("medias","write_form")))},onFail:function(){switch(Array.prototype.slice.call(arguments).shift()){case 2:this.link.form&&this.link.form.submit()}}},Dialogs={onStart:function(){var a=geByClass("pages","mcont");each(a,function(a,c){before(ce("div",{className:"loading",innerHTML:"<i></i>"}),c.firstChild)})},onDone:function(a,b){var c=ge("dialogs");c&&(val(c,a),!this.no_scroll&&scrollToEl(),mail.cacheDialogsPage());mail.save(b)}},reply={show:function(a){reply.hideall();addClass("reply_to",geByClass1("reply_wrap","wall_reply"+a));addClass("reply_to","reply_add"+a);replaceClass("add_reply","reply_to",geByClass1("pcont","mcont"));elfocus(geByTag1("textarea","reply_add"+a));return!1},hide:function(){replaceClass("reply_to","add_reply",geByClass1("pcont","mcont"));elfocus(geByTag1("textarea","reply_add"));return!1},hideall:function(){for(var a=geByClass1("replies","mcont"),a=geByClass("post",a),b=0,c=a.length;b<c;b++){var d=a[b],e=ge(d.id.replace("wall_reply","reply_add"));removeClass("reply_to",geByClass1("reply_wrap",d));removeClass("reply_to",e)}return!1},greeting:function(a,b){var c=geByTag1("textarea",b||geByClass1("post_add","mcont"));if(!c)return!0;var d=c.value.match(/\[post\d+\|[^\]]+\]/g),e=0,f;for(f in d||{})++e;10>e&&(c.value+=a);edit.hide();elfocus(c);return!1}},edit={show:function(a){edit.hideall();addClass("edit","post"+a);addClass("edit","edit_post"+a);addClass("edit_post",geByClass1("pcont","mcont"));elfocus(geByTag1("textarea","edit_post"+a));return!1},hide:function(){removeClass("edit_post",geByClass1("pcont","mcont"));return!1},hideall:function(){for(var a=geByClass1("msgs","mcont"),a=geByClass("post",a),b=0,c=a.length;b<c;b++){var d=a[b],e=ge(d.id.replace("post","edit_post"));removeClass("edit",d);removeClass("edit",e)}return!1}},post={add_attach:function(a){var a=gpeByTag("form",a),b=ce("input",{type:"hidden",name:"add_attach",value:1});a.appendChild(b);a.submit();return!1}},menu={opened:function(){return hasClass("lm_opened",bodyNode)},toggle:function(a,b){if(checkEvent(a)||!window.al||!window.al.menu)return!0;menu.opened()?menu.close(a,b):menu.open(a,b);return!1},open:function(a){if(checkEvent(a)||!window.al||!window.al.menu)return!0;if(menu.opened())return!1;menu.clear_hover();a=ce("div",{id:"m_helper",onclick:menu.close});append(a,"m");menu._st=scrollTop();addClass("lm_opened",bodyNode);menu.fix_size();scrollTop(0);ajax.post("/",{_ajax:1,act:"ping"});window.lm_qsearch_counter?lm_qsearch_counter--:lm_qsearch_counter=-1;lm_qsearch_counter&&menu.cancelSearch();return!1},close:function(a){if(checkEvent(a)||!window.al||!window.al.menu)return!0;if(!menu.opened())return!1;remove("m_helper");menu.clear_hover();a=scrollTop();removeClass("lm_opened",bodyNode);menu.fix_size(!0);scrollTop(menu._st+a);window.lm_qsearch_focused&&menu.cancelSearch();return!1},fix_size:function(a){var b=ge("l"),c=ge("m"),d=ge("mhead"),d=d&&d.offsetHeight||0,e=menu._st||0;b&&(a?(c.style.width="100%",c.style.minHeight="0",c.style.marginTop="0"):(e=e>d?e:0,b.style.minHeight=getCh()+"px",c.style.width=Math.min(604,getCw())+"px",c.style.minHeight=b.offsetHeight+e+"px",c.style.marginTop=-e+"px"))},clear_hover:function(){thover.clear();removeClass("active",geByClass1("active","l"))},refreshCounters:function(a){if(!a||!a.length||!window.al||!window.al.menu)return!0;if(a.length!=window.al.menu.length)return!1;var b=geByClass1("main_menu","l");each(a,function(a,d){if("undefined"===typeof d)return!0;var e=al.menu[a],f=geByClass1(e[0],b),h=geByTag1("a",f),f=geByTag1("span",f),i=geByTag1("em",f);attr(h,"data-href",!1);d?(e[2]&&attr(h,"href",e[2]),i?val(i,d):append(ce("em",{innerHTML:d}),f)):(e[1]&&attr(h,"href",e[1]),remove(i));ajax.prepare_click(h)});return!0},refresh:function(a){a=a||{};a.fv_link&&attr("lm_fv_link","href",a.fv_link);"undefined"!==typeof a.tn&&!1!==a.tn&&val("lm_top_notify",a.tn);"undefined"!==typeof a.bn&&!1!==a.bn&&val("lm_bottom_notify",a.bn)},initTouch:function(){function a(a){var b=a.touches;return{x:a.pageX||b&&b[0]&&b[0].pageX||0,y:a.pageY||b&&b[0]&&b[0].pageY||0}}if(isTouch){var b=!1,c=!1,d=Math.min(604,getCw())/3;addEvent(document,"touchstart",function(d){geByClass1("btn home","mhead")&&(b=c=a(d))});addEvent(document,"touchmove touchend touchcancel",function(e){if(b){"touchmove"==e.type&&(c=a(e));var f;f=c.x-b.x;var h=c.y-b.y;f=Math.sqrt(f*f+h*h);h=Math.abs(180*Math.atan2(b.y-c.y,c.x-b.x)/Math.PI);if("touchend"==e.type||"touchcancel"==e.type)if(b=!1,"touchcancel"==e.type)return;10>f||(menu.opened()&&(h=180-h),30<h?b=!1:(e&&cancelEvent(e),f>d&&(b=!1,menu.toggle())))}})}},cancelSearch:function(){if(!window.al||!window.al.menu)return!0;lm_qsearch&&lm_qsearch.clear();removeClass("qs_opened","vk_wrap");return!1}},mail=function(){function a(){if(h){var a=[];each(geByClass("_unread"),function(b,c){var d=/(?:^|\s)_msg([0-9]+)(?:\s|$)/i.exec(c.className)[1]||0;d&&a.push(d)});a.length&&mail.sendMarkAsRead(h,a)}}function b(a,b){b?-1==b?replaceClass("lvi","mlvi",a):replaceClass("mlvi","lvi",a):(removeClass("lvi",a),removeClass("mlvi",a))}var c={},d,e,f,h=null,i=!1,k={},g={},v={},l=null;return{init:function(b,c){b&&(h=b,c&&mail.saveDialog(c,b));i||(i=!0,addEvent(document,isTouch?"touchstart":"click",a));im.on()},clear:function(){c={};f=e=d=void 0;k={};h=null;removeEvent(document,isTouch?"touchstart":"click",a);i=!1;im.off()},send:function(a,b){return ajax.click(a,extend({clear:!0,save:b},Dialog),{lock:!0})},save:function(a){each(a,function(a,b){c[a]&&b.last_msg==c[a].last_msg&&delete b.messages;mail.saveDialog(b,a)})},saveDialog:function(a,b){c[b]||(c[b]={});var d=c[b];extend(d,a);d.msgs&&each(d.msgs,function(a,c){k[c]=b})},getPeerByMsg:function(a){return k[a]||!1},cacheDialogsPage:function(){d=val("m");e=nav.cur},keyup:function(a,b,c){var d=l||"",a=a.value||"";if(d.length!=a.length||d!=a)mail.myTyping(b,c),l=a},myTyping:function(a,b){if(!(0>=a)){var c=vkNow();v[a]&&5E3>c-v[a]||(v[a]=c,ajax.post("/mail",{_ajax:1,act:"typing",peer:a,hash:b}))}},typing:function(a,b){b=b||a;2E9<a?(g[a]||(g[a]={}),g[a][b]=vkNow()):g[a]=vkNow();mail.updateTyping(a)},updateTyping:function(a){var b=ge("dialog_near"+a),c=geByClass1("write_to",b),d=geByClass1("typing",b);if(b){var e=[],f=vkNow();if(2E9<a)each(g[a]||{},function(a,b){attr(d,"data-u"+a)&&(b&&6E3>f-b)&&e.push(a)});else{var n=g[a];attr(d,"data-u"+a)&&(n&&6E3>f-n)&&e.push(a)}if(e.length){if(1==e.length){var r=e[0],n=attr(d,"data-u"+r),r=attr(d,"data-s"+r);val(d,"<i></i>"+(lang.mobile_mail_typing[r]||"").replace("{user}",n))}else each(e,function(a,b){e[a]=attr(d,"data-u"+b)}),n=e.pop(),val(d,"<i></i>"+(lang.mobile_mail_multi_typing||"").replace("{users}",e.join(", ")).replace("{last_user}",n));c.offsetWidth&&style(d,"minWidth",c.offsetWidth);addClass("is_typing",b);setTimeout(function(){addClass("animated",b)},10);setTimeout(function(){mail.updateTyping(a)},2E3)}else val(d,""),style(d,"minWidth",0),removeClass("animated",b),removeClass("is_typing",b)}},updateOnline:function(a,d){var e=ge("messages"+a);e&&remove(geByClass1("activity",e));each(geByClass("_lv"+a,"mcont"),function(a,c){b(c,d)});c[a]&&(c[a].write_form&&(e=ce("div",{innerHTML:c[a].write_form}),each(geByClass("_lv"+a,e),function(a,c){b(c,d)}),c[a].write_form=val(e)),c[a].messages&&(e=ce("div",{innerHTML:c[a].messages}),remove(geByClass1("activity",e)),c[a].messages=val(e)))},sendMarkAsRead:function(a,b){isArray(b)||(b=[b]);var d=c[a];d&&d.hash&&ajax.post("/mail",{_ajax:1,act:"mark_read",peer:a,msgs:b.join(","),hash:d.hash},{onDone:function(c){c&&each(b,function(b,c){mail.markAsRead(a,c)})}})},markAsRead:function(a,b){var d=ge("messages"+a);if(d&&(removeClass("new",geByClass1("_msg"+b,d)),(d=c[a])&&d.messages)){var e=ce("div",{innerHTML:d.messages});removeClass("new",geByClass1("_msg"+b,e));d.messages=val(e)}},markAsDeleted:function(a,b){var d=ge("messages"+a);if(d&&(remove(geByClass1("_msg"+b,d)),(d=c[a])&&d.messages)){var e=ce("div",{innerHTML:d.messages});remove(geByClass1("_msg"+b,e));d.messages=val(e)}},addMessage:function(a,b,d,e){2E9>a?delete g[a]:g[a]&&delete g[a][d];mail.updateTyping(a);if(!0===e)ge("dialogs")&&"/mail"==nav.path&&(e=qs2obj(nav.params),!e.act&&(!e.offset&&!e.q)&&ajax.click("/mail",extend({no_scroll:!0},Dialogs)));else if(a&&b&&(k[b]=a),!geByClass1("_msg"+b))if((d=c[a])&&d.messages){d.msgs&&d.msgs.push(b);var f=ce("div",{innerHTML:d.messages});(b=geByClass1("activity",f))?(after(cdf(e),b),d.messages=val(f)):d.messages=e+d.messages;(a=ge("messages"+a))&&val(a,d.messages)}else if(a=ge("messages"+a))(b=geByClass1("activity",a))?after(cdf(e),b):val(a,e+val(a))},getMsgHTML:function(a,b,d,e,f,g,n){var r=b&2?vk.id:n&&n.from||d;if(!r)return!1;if(!ge("messages"+d))return!0;if(n.attach1||n.fwd||n.emoji||!c[d]||!c[d].hash)return!1;var n="_u"+r,h=geByClass1(n,"mcont","a"),r=stripTags(attr(h,"data-name")||val(h)||""),h=getHref(h),i=geByClass1(n,"mcont","img"),i=i&&i.src||"";if(!r||!h||!i)return!1;d=intval(d);a=intval(a);f=f&&-1==f.toString().indexOf(" ... ")&&2E9>d?f:"";msg_class=b&1?" new":"";!(b&2)&&b&1&&(msg_class+=msg_class?" _unread":"");a='<a name="msg'+a+'"></a><div class="msg _msg'+a+msg_class+'"><div class="i"><a class="al'+n+'" href="'+h+'"><img src="'+i+'" class="u '+n+'" align="left"></a></div><div class="cont"><div class="ch"><a class="date" href="/mail?act=msg&amp;id='+a+'">';b=new Date(1E3*e);e=b.getHours();b=b.getMinutes();return a+(e+":"+(10>b?"0":"")+b)+'</a><a class="user al'+n+" "+n+'" href="'+h+'" data-name="'+escapeAttr(r)+'">'+r.split(" ").shift()+'</a></div><div class="cc">'+(f?'<div class="title">'+f+"</div>":"")+'<div class="text">'+g+'</div></div></div><div class="cb"></div></div>'},showDialog:function(a,b,d){f=scrollTop();var e=c[b];if(e){var g=ce("div",{innerHTML:val("m")}),s=geByClass1("btn back",geByClass1("mhead",g)),n;e.header&&val(s,e.header);(n=geByTag1("a",s))&&n.setAttribute("onclick","return nav.go(this, event);");val(geByClass1("pcont",geByClass1("mcont",g)),e.write_form+(b?'<div id="messages'+b+'" class="messages">'+(e.messages||"")+'<div id="al_loading"></div></div>':""));e.fv_link&&(attr(geByClass1("fv_link",g),"href",e.fv_link),attr("lm_fv_link","href",e.fv_link));attr(geByClass1("app_link",g),"onclick",e.app_link?"return nav.app_go(this, event, '"+escapeAttr(e.app_link)+"');":!1);val("m",g.innerHTML);alLoadingFix();h=b;a=getHref(a);nav.go(a,null,{push_only:!0,no_push:d});b?(l=null,mail.updateTyping(b),ajax.click(a,extend({save:b},Dialog),{scroll:!0})):qsearch.init({init_once:!0,action:"/mail?act=write&fast=1",container:geByClass1("peers","mcont"),field:ge("qsearch_fld"),btn:ge("qsearch_btn"),top_items:[],_cache:{},hl_fields:[2],item_tpl:function(a,b,c,d,e){return'<div class="member"><a href="'+(a||"")+'" class="tap" onclick="return mail.showDialog(this, '+(this.id||0)+');">'+(b||"")+'<div class="cont"><span class="user">'+c+"</span>"+d+(e?'<div class="status">'+e+"</div>":"")+"</div></a></div>"},null_tpl:function(){return'<div class="m"><div class="null">'+lang.mobile_friends_no_friends+"</div></div>"},need_invalid_keys:browser.desktop,onLoaded:function(a){for(var b in a)mail.saveDialog(a[b][a[b].length-1],b)}});scrollTop(0,10)}else nav.al_go(e&&e.cur_link||getHref(a)||nav.cur);return!1},backToDialogs:function(a){if(d)nav.go(e,null,{push_only:!0,no_push:a}),ajax.click(e,extend({no_scroll:!0},Dialogs)),val("m",d),attr("lm_fv_link","href",attr("fv_link","href")||attr("fv_link","data-href")),h=null,scrollTop(f||0);else{var b=e||"/mail";nav.go(b,null,{push_only:!0,no_push:a});nav.al_go(b)}}}}(),im=function(){function a(){64>d&&(d*=2)}var b=null,c={},d=1,e=null,f=!1,h=!1;return{init:function(a,c){if(!b){var d=(document.domain||"").match(/(m\.)?([a-zA-Z]+\.[a-zA-Z]+\.?)$/);window.locDomain="https:"==location.protocol?d[2]:d[0];navigator.userAgent.toLowerCase();if(browser.opera||!browser.msie6||document.domain!=locDomain)document.domain=locDomain;b=ce("iframe",{src:a},{display:"none"});onDOMReady(function(){append(b,bodyNode)})}im.refreshParams(c);setTimeout(im.check,1E3)},on:function(){clog("longpoll start");f=!0;setTimeout(im.check,1E3)},off:function(){clog("longpoll pause");f=!1},refreshParams:function(a){extend(c,a||{});extend(im,c)},getKey:function(){if(e)try{e.abort()}catch(b){}e=ajax.post("/mail",{_ajax:1,act:"im_get_key"},{onDone:function(a){/[0-9a-f]{40}/i.test(a)?(im.refreshParams({key:a}),im.check()):clog("invalid key")},onFail:function(){setTimeout(im.getKey,1E3*d);clog("from getKey delaying getKey for "+d+"secs");a()}})},check:function(){if(f&&!h){im.makeRequest||setTimeout(im.check,1E3);try{im.makeRequest(function(b,c){h=!1;if(vk.__debug){var e=im.checked(parseJSON(c));clog("success",e);e&&(im.check(),d=1)}else try{e=im.checked(parseJSON(c)),clog("success",e),e&&(im.check(),d=1)}catch(f){try{clog("error",f.message||"no message",f.type||"no type",f.stack||"no stack")}catch(i){}setTimeout(im.check,1E3*d);a()}},function(){h=!1;setTimeout(im.check,1E3*d);a()}),h=!0}catch(b){clog("makeRequest failed")}}},checked:function(b){var e=b.failed;if(1==e||c.ts>=b.ts+256){if(im.refreshParams({ts:b.ts}),e)return!0}else{if(2==e)return clog("delaying getKey for "+d+"secs"),setTimeout(im.getKey,1E3*d),a(),!1;if(e){clog(b);return}}clog("ts",b.ts,c.ts);im.refreshParams({ts:b.ts});if(b.updates){var e=[],f=[],h;for(h in b.updates){var l=b.updates[h],j=intval(l[0]),q=intval(l[1]),p=intval(l[2]),m=intval(l[3]);clog(l);51!=j&&(61==j?mail.typing(q):62==j?mail.typing(2E9+p,q):8==j?e.push(-q):9==j?mail.updateOnline(-q,0):m&&(4==j?(j=p&2?vk.id:l[7]&&l[7].from||m,(l=mail.getMsgHTML(q,p,m,l[4],l[5],l[6],l[7]))?(mail.addMessage(m,q,j,l),p&2||(q=getNotify()+1,setNotify(q),window.al&&window.al.menu&&(p=Array(al.menu.length),p[2]=q,menu.refreshCounters(p)))):f.push({peer:m,msg_id:q,from_id:j})):0==j?mail.markAsDeleted(q):2==j?p&128&&mail.markAsDeleted(m,q):3==j&&p&1&&mail.markAsRead(m,q)))}e.length&&ajax.post("/mail",{_ajax:1,act:"get_onlines",uids:e.join(",")},{onDone:function(a){each(a,function(a,b){mail.updateOnline(a,b)})}});if(f.length){var w=[];each(f,function(a,b){w.push(b.msg_id)});ajax.post("/mail",{_ajax:1,act:"get_messages",msgs:w.join(",")},{onDone:function(a){each(f,function(b,c){a[c.msg_id]&&mail.addMessage(c.peer,c.msg_id,c.from_id,a[c.msg_id])})}})}}return!0}}}(),geoloc=function(){function a(a,b){var c=ge("medias_map");ge("feed_add_form");var d=ge("attached_wrap");c||(c=ce("div",{id:"medias_map",className:"medias"}),d.appendChild(c));var d=a.latitude,e=a.longitude,v=geByClass1("row map",c),l=b?'<div class="close"><i>&nbsp;</i></div><div class="label">'+b+"</div>":"";map_field='<input type="hidden" name="map" value="'+(d+"_"+e+"_0")+'">';v?val(v,l+""+map_field):val(c,'<div class="row map" onclick="geoloc.remove();">'+l+""+map_field+"</div>");show(c)}function b(b){if(b&&b.coords){var e=d={latitude:+b.coords.latitude||0,longitude:+b.coords.longitude||0};ajax.post("/places.php",{_ajax:1,act:"map_label",lat:e.latitude,lng:e.longitude},{onDone:function(b){hide("geo_waiting");a(e,b)},onFail:c})}}function c(){geoloc.remove();hide("geo_waiting")}var d=null,e=!1;return{toggle:function(){e?geoloc.remove():geoloc.add()},add:function(f){if(f||!e)e=!0,addClass("sel","geo_btn"),f&&(f.latitude||f.longitude)?(d={latitude:+f.latitude||0,longitude:+f.longitude||0},a(d,f.label)):(geo.getCurrentPosition(b,c),show("geo_waiting"))},remove:function(){e&&(e=!1,removeClass("sel","geo_btn"),d=null,remove("medias_map"))},init:function(a){a&&geoloc.add(a);return geo.init()}}}(),checkin=function(){function a(a,b){ajax.post("/places.php",{_ajax:1,act:"search",lat:a.latitude,lng:a.longitude},{onDone:function(d,e,f){hide("geo_waiting");j=d||{};q=e||[];p=f||0;if(m)return c();if(!b){if(e.length)return c();h(a)}},onFail:function(){checkin.remove();hide("geo_waiting")}})}function b(a){l=!1;var b=ge("medias_map");ge("feed_add_form");var c=ge("attached_wrap");b||(b=ce("div",{id:"medias_map",className:"medias"}),c.appendChild(b));var c=+a[1]||0,d=a[3]||"",e=a[4]||"",f=a[5]||"",a=(+a[6].lat||0)+"_"+(+a[6].lng||0),t=geByClass1("row link checkin",b),d='<div class="close" onclick="checkin.remove();"><i>&nbsp;</i></div><div class="label" onclick="checkin.changePlace();">'+d+(f?", "+f:e?", "+e:"")+"</div>";checkin_field='<input type="hidden" name="place_id" value="'+c+'"><input type="hidden" name="place" value="'+a+'">';t?val(t,d+checkin_field):(d='<div class="row map">'+d+checkin_field+"</div>",val(b,d));addClass("sel","geo_btn");v=!0;show(b)}function c(a){m||(m=val("m"));var b=ce("div",{innerHTML:m});val(geByClass1("btn back",b),'<a class="b" onclick="checkin.back(); return false;"><i>&nbsp;</i><div class="title"><h1>'+lang.mobile_geo_head_title+"</h1></div></a>");var c=Math.min(604,getCw())||0,d=Math.ceil(c/2)||0,e=g.latitude,f=g.longitude,c='<div style="background: url(//maps.googleapis.com/maps/api/staticmap?center='+e+","+f+"&amp;zoom=14&amp;size="+c+"x"+d+"&amp;scale="+(1.5<=window.devicePixelRatio?2:1)+"&amp;sensor=true&amp;language=ru) #fff no-repeat center; background-size: "+c+"px "+d+'px;"><div class="img" style="width: '+c+"px; height: "+d+"px; background: url("+(1.5<=window.devicePixelRatio?"/images/x_map_point.png":"/images/map_point.png")+') no-repeat center; background-size: 180px 70px;"></div></div>';val(geByClass1("pcont",geByClass1("mcont",b)),'<div class="checkin_map" onclick="checkin.refreshCurrentPosition();">'+c+'</div><div id="places_box"><div class="panel"><form class="oneline qsearch" onsubmit="qsearch.go(event); return false;"><table><tr><td width="100%"><div class="iwrap"><input id="qsearch_fld" type="text" class="text" name="q" value="" placeholder="'+lang.mobile_geo_places_placeholder+'"></div></td><td class="last"><input id="qsearch_btn" type="submit" class="btn" value="'+lang.mobile_search_btn+'" onclick="return qsearch.go(event);"></td></tr></tbody></table></form></div><div class="items"></div></div><div id="place_add_box" style="display:none;"></div>');val("m",b.innerHTML);nav.go(nav.path+(nav.params?"?"+nav.params:"")+"#select_place",null,{push_only:!0,no_push:a});a="/places.php?act=search&lat="+e+"&lng="+f;qsearch.init({action:a,al_action:a,container:geByClass1("items","mcont"),field:ge("qsearch_fld"),btn:ge("qsearch_btn"),top_items:q||[],_cache:j||{},hl_fields:[2,3],tpl:function(a,b){var c=b?lang.mobile_geo_place_add_link.replace("%s",htsc(b)):lang.mobile_geo_place_add_item,d=escapeAttr(b||""),e=escapeAttr(checkin.getCurrentAddress());return a+'<div class="member new_place"><a class="tap" onclick="checkin.addPlaceShow(\''+d+"', '"+e+"'); return false;\">"+(a?'<div class="i"></div>':"")+'<div class="cont"><span class="user">'+c+"</span>"+(e?'<div class="info">'+e+"</div>":"")+"</div></a></div>"},item_tpl:function(a,b,c,d){return'<div class="member place"><a class="tap" onclick="return checkin.selectPlace(this, '+(this.id||0)+');">'+(b||"")+'<div class="cont"><span class="user">'+(c||"")+"</span>"+(d?'<div class="info">'+d+"</div>":"")+"</div></a></div>"},null_tpl:function(){return""},top_len:10,need_invalid_keys:browser.desktop,load_limit:p,onLoaded:function(a){extend(j,a)},al_need:!0});return!1}function d(){val("place_add_box","");hide("place_add_box");show("places_box")}function e(a,c){f();var d=j[c];d&&(g={latitude:+d[6].lat||0,longitude:+d[6].lng||0},c?b(d):h(g,d))}function f(a){if(!m)return!0;val("m",m);m=null;scrollTop(0);nav.go(nav.path+(nav.params?"?"+nav.params:""),null,{push_only:!0,no_push:a});return!1}function h(a,b){l=!0;var c=ge("medias_map");ge("feed_add_form");var d=ge("attached_wrap");c||(c=ce("div",{id:"medias_map",className:"medias"}),d.appendChild(c));var d=a.latitude,e=a.longitude,f=b&&b[4]||!1,t=geByClass1("row map",c),f=f?'<div class="close" onclick="checkin.remove();"><i>&nbsp;</i></div><div class="label" onclick="checkin.changePlace();">'+f+"</div>":"";map_field='<input type="hidden" name="map" value="'+(d+"_"+e+"_0")+'">';t?val(t,f+""+map_field):val(c,'<div class="row map">'+f+""+map_field+"</div>");v=!0;addClass("sel","geo_btn");show(c)}function i(b){b&&b.coords&&(g={latitude:+b.coords.latitude||0,longitude:+b.coords.longitude||0},a(g))}function k(){checkin.remove();hide("geo_waiting")}var g=null,v=!1,l=!1,j={},q=[],p=0,m=null,w="";return{toggle:function(){v?checkin.remove():checkin.add()},addNewPlace:function(){var a=val("place_name_fld"),b=val("place_address_fld");if(!a)return elfocus("place_name_fld"),!1;lockButton("place_add_btn");ajax.post("/places.php",{_ajax:1,act:"add_place",latitude:g.latitude,longitude:g.longitude,title:a,address:b,hash:w},{onDone:function(a,b){unlockButton("place_add_btn");if(a){var c={};c[a]=b;extend(j,c);q.splice(q[0]?0:1,0,a);d();e(null,a)}},onFail:function(){unlockButton("place_add_btn");var a=Array.prototype.slice.call(arguments).shift(),b=ge("place_add_form");switch(a){case 2:b&&b.submit()}}});return!1},addPlaceShow:function(a,b){var c="/places.php"+obj2qs({act:"add_place",latitude:g.latitude,longitude:g.longitude,hash:w});val("place_add_box","<h4>"+lang.mobile_geo_new_place_header+'</h4><form id="place_add_form" action="'+c+'" method="post" class="place_add_box"><div class="cont"><dl><dt>'+lang.mobile_geo_place_name_label+'</dt><dd class="iwrap"><input type="text" class="text" id="place_name_fld" name="title" /></dd></dl><dl><dt>'+lang.mobile_geo_place_address_label+'</dt><dd class="iwrap"><input type="text" class="text" id="place_address_fld" name="address" /></dd></dl><div class="near_box"><input class="btn" type="submit" id="place_add_btn" value="'+lang.mobile_geo_place_add_btn+'" onclick="return checkin.addNewPlace(this);" /><div class="near_btn"><a onclick="checkin.addPlaceCancel(); return false;">'+lang.mobile_cancel+"</a></div></div></div></form>");val("place_name_fld",a||"");val("place_address_fld",b||"");hide("places_box");show("place_add_box");a?elfocus("place_address_fld"):elfocus("place_name_fld")},addPlaceCancel:d,selectPlace:e,changePlace:c,back:f,refreshCurrentPosition:function(){geo.getCurrentPosition(i,k)},getCurrentAddress:function(){return j[0]&&j[0][5]||""},add:function(d){if(!d&&v)return c();d&&(d.latitude||d.longitude)&&d.place?(g={latitude:+d.latitude||0,longitude:+d.longitude||0},d.place[1]?b(d.place):h(g,d.place),a(g,!0)):(geo.getCurrentPosition(i,k),show("geo_waiting"))},remove:function(){v=!1;removeClass("sel","geo_btn");g=null;j={};q=[];p=0;remove("medias_map")},stash:function(a){if(a)g=a[0],v=a[1],l=a[2],j=a[3],q=a[4],p=a[5],m=a[6];else return[g,v,l,j,q,p,m]},init:function(a,b){g=null;l=v=!1;j={};q=[];p=0;m=null;w=b||"";a&&checkin.add(a);return geo.init()}}}();function QuickSearch(a){function b(a){var a=a.replace(/https?:\/\/(m\.)?vk\.com\/([^#]+#\/)?/,""),b,c,d=H,a=[a,b=parseRusKeys(a,d)||a,c=parseLatKeys(a,d)||a,parseLat(b),parseCyr(c)];c={};for(var d=[],e=0,f=a.length;e<f;e++)a[e]&&!c[a[e]]&&(c[a[e]]=!0,b=escapeRE(a[e]),d.push(RegExp("(^|\\s|\\(|>)("+b+")","gi")));return d}function c(a,t,u){clearTimeout(r);if(!u)return r=setTimeout(function(){c(a,t,!0)},10),!1;u=val(a)||"";if(n==u)return!1;var g="_"+u,h=p[g],A=b(u),i;if(!h&&2<u.length&&p["_"+u.slice(0,-2)]){var l="_"+u.slice(0,-2);if(p[l]&&(w[l]&&!p[l].length)&&(!D||D&&!m[l]))w[g]=!0,h=p[g]=[],D&&(m[g]="")}if(h)clog("`"+u+"`: from cache");else{h=[];l=0;if(!u&&j.length)for(var C=z,k=z+Math.min(F,j.length);C<k;C++)h.push([j[C]]),l++;else{for(var G={},E=0,C=0,k=j.length;C<k;C++){var s=j[C];if(q[s]){G[s]=!0;if(i=e(A,q[s][0]))if(h.push([s,i]),++E>=K)break;l++}}if(E<K)for(s in q)if(!G[s]&&(i=e(A,q[s][0]))){h.push([s,i]);if(++E>=K)break;l++}}clog("`"+u+"`: analyse "+l+" peers, "+h.length+" found");w[g]=w[g]||!u&&j.length||h.length>2*F;w[g]=w[g]||D&&h.length>F}if(!w[g]&&(I||D))clog("`"+u+"`: need load"),d(a,u);p[g]=h;n=u;f(h,m[g]);N&&N(u);al_need&&!n&&(J=F);return!1}function d(a,c,t){clearTimeout(B);if(!t)return B=setTimeout(function(){d(a,c,!0)},200),!1;ajax.post(h,{_ajax:1,q:c},{onDone:function(d,t,u){C&&C.apply(null,arguments);for(var g="_"+c,h=p[g]||[],A={},i=b(c),l,k=0,j=h.length;k<j;k++)A[h[k][0]]=!0;k=0;for(j=t.length;k<j;k++){var G=t[k];A[G]||((l=e(i,d[G][0]))||E||!c)&&h.push([G,l])}clog("`"+c+"`: loaded. now "+h.length+" peers");w[g]=!0;p[g]=h;D&&(m[g]=u||"");q=extend(d,q);I=!x||len(q)<x;n==c?f(h,m[g]):delete p[g];removeClass("loading",a)},onFail:function(){delete p["_"+c];removeClass("loading",a)}});geByClass1("al_loading",k)||addClass("loading",a)}function e(a,b){if(!b)return!1;for(var c=0,d=a.length;c<d;c++)if(-1!==b.search(a[c]))return a[c];return!1}function f(a,b){var c="";if(A&&k){for(var d=0,e=a.length;d<e;d++){var f=a[d][0],h=a[d][1];if(q[f]){var i=q[f].slice(1);if(h)for(var C in y){var m=y[C];i[m]&&(i[m]=i[m].replace(h,"$1<em>$2</em>"))}c+=A.apply({id:f,q:n,highlight:function(a){return(a||"").replace(h,"$1<em>$2</em>")}},i)}}if(!c&&!w["_"+n]&&(I||D))removeClass("loading",g),c=n?'<div class="al_loading qs_loading">&nbsp;</div>':'<div id="al_loading"></div>';!c&&u&&(c=u(n));clog("rendered");val(k,t?t(c,n,al_need,b):c+(b||""));l&&(n?show(l):hide(l));!n&&alLoadingFix();O&&O()}}var h,i,k,g,v,l,j=[],q={},p={},m={},w={},s=!1,n=null,r=null,B=null,z=0,y=[],t=null,A=null,u=null,E=!1,H=!1,F=10,K=30,I=!0,x=!1,D=!1,C,N,O,G,J=0,L=0,M=!1;extend(this,{go:function(a){if(!g)return!0;c(g,a,!0);g.blur();cancelEvent(a);return!1},clear:function(a,b){val(g,"");b?elfocus(g):elblur(g);c(g,a,!0);cancelEvent(a);return!1},init:function(a){clog(a);a=a||{};k=ge(a.container)||null;g=ge(a.field)||null;v=ge(a.btn)||null;l=ge(a.clear_btn)||null;n=null;if(!s||h!=a.action||!a.init_once)p={},m={},w={},h=a.action||"",i=a.al_action||h,j=a.top_items||[],q=a._cache||{},y=a.hl_fields||[],t=a.tpl||null,A=a.item_tpl||null,u=a.null_tpl||null,E=a.soft_filter||!1,H=a.need_invalid_keys||!1,F=a.top_len||10,x=a.load_limit||!1,C=a.onLoaded||!1,N=a.onFiltered||!1,O=a.onRendered||!1,G=a.onFocusChanged||!1,al_need=a.al_need||!1,z=!al_need&&a.init_offset||0,D=a.global_search||!1;var b=null;if(h&&k&&g&&A){I=!0!==h&&(!x||len(q)<x);addEvent(g,"focus",function(a){var d=function(e){!e&&c(g,a,!0);b=setTimeout(d,100)};clearTimeout(b);G&&G.call({q:n},!0);d(!0)});addEvent(g,"keydown keypress change blur",function(a){"blur"==a.type&&(clearTimeout(b),G&&G.call({q:n},!1));c(g,a,"keydown"!=a.type&&"keypress"!=a.type)});a._new||v&&!attr(v,"onclick")&&attr(v,"onclick","return qsearch.go(event);");if(al_need&&(!s||!a.init_once))J=F,L=len(q),initAutoScroll(function(){var a=k.childNodes;return a[J]||a[a.length-1]},function(){if(!M&&!n)if(J+F>L&&I)M=!0,ajax.post(i,{_ajax:1,offset:L},{onDone:function(a,b){C&&C.apply(null,arguments);var c=len(a);M=!1;x||(j=j.slice(0,L).concat(b));L+=c;q=extend(a,q);I=!0!==h&&(!x&&c||len(q)<x);if(!n){J+=F;for(var c=[],d=0,e=Math.min(J,j.length);d<e;d++)c.push([j[d]]);clog("scroll loaded. show "+c.length+" peers");f(c,m._)}},onFail:function(){M=!1}});else if(J<j.length){J+=F;for(var a=[],b=0,c=Math.min(J,j.length);b<c;b++)a.push([j[b]]);clog("scroll from cache. show "+a.length+" peers");f(a,m._)}});!a.skip_init_filter&&c(g,null,!0);s=!0}}});a&&this.init(a)}var qsearch=new QuickSearch,photo=function(){function a(){g=geByClass1("photoview");if(!g)return nav.al_go(nav.cur),!1;v=geByClass1("summary",g);pt=geByClass1("tag_info_wrap",g);q=geByClass1("photo_wrap",g);p=geByClass1("pv",q);j=geByClass1("nav",q);m=geByTag1("a",p);w=geByTag1("img",p);s=geByClass1("desc",g);n=geByClass1("actions",g);r=geByClass1("comments_wrap",g);if(!(l=geByClass1("loading",v)))l=ce("div",{innerHTML:"<i></i>",className:"loading"},{display:"none"}),v.appendChild(l);if(j){var a=geByTag("a",j);B=a[0];z=a[1];B&&B.setAttribute("onclick","return photo.prev(event);");z&&z.setAttribute("onclick","return photo.next(event);");m&&m.setAttribute("onclick","return photo.next(event);");ajax.prepare_click([B,z,m])}removeEvent(window,"orientationchange",f);addEvent(window,"orientationchange",f);return!0}function b(a){var b=[];each(a,function(a,c){if(!c)return!0;b.push(y[c.id]=c)});return b}function c(a){return y[a]||{}}function d(a,c,d){null===c?delete t[a]:(t[a]||(t[a]=Array(d?d:d(c))),b(c),a=t[a],H&&a.reverse(),extend(a,c),H&&(u=copy(a),a.reverse()))}function e(a){if("string"!==typeof a)return a;a=t[a]||[];return H?copy(a).reverse():a}function f(){nav.hash||onDOMReady(function(){if(geByClass1("photoview")){var a=scrollTop();q&&getY(q)<a&&scrollToEl(q)}})}function h(a,b,c){var e=u[a],t=1==u.length;if(e){f();var g={};F&&(g.list=F);H&&(g.rev=1);K&&(g.from=K);var j=obj2qs(g),g="photo"+e.id+j,p=e.photo,q=(i(a-1)||{}).id,a=(i(a+1)||{}).id;t||(m.href="/photo"+a+j,B.href="/photo"+q+j,z.href="/photo"+a+j,ajax.prepare_click([B,z,m]));w&&w.src!=p&&(w.onload=null,remove(w),w=ce("img",{src:p,alt:""}),append(w,m));val(geByTag1("span",v),x+1);val(pt,e.tag_info||"");t="";e.caption&&(t+='<div class="text">'+e.caption+"</div>");e.album_link&&(t+="<dl><dt>"+lang.mobile_photos_photo_album_label+"</dt><dd>"+e.album_link+"</dd></dl>");e.author_link&&(t+="<dl><dt>"+lang.mobile_photos_photo_author_label+"</dt><dd>"+e.author_link+"</dd></dl>");if(e.date||e.likes||e.publish)t+='<div class="info">'+(e.date||"")+(e.likes||"")+(e.publish||"")+"</div>";val(s,t);val(n,e.actions||"");val(r,e.comments_html||"");e.fv_link&&(attr("fv_link","href",e.fv_link),attr("lm_fv_link","href",e.fv_link));attr("app_link","onclick",e.app_link?"return nav.app_go(this, event, '"+escapeAttr(e.app_link)+"');":!1);nav.go("/"+g,null,{no_push:b,push_only:!0,replace:c})}if(!I){if(!D){b=!1;c=1;for(e=0;5>e;e++)t=e+x,g=i(t),g||(b=t,c=1);if(!1===b)for(e=-1;-3<e;e--)t=e+x,g=i(t),g||(b=t,c=-1);if(!1!==b&&(e=i(x)))D=!0,show(l),ajax.post("/photos.php",{_ajax:1,oid:e.owner_id,list:E,offset:b,direction:c,rev:H?1:0},{onDone:function(a){hide(l);D=!1;d(E,a,u.length);h(x,!0)}})}b=0;for(c=x+1;b<k;b++){var y=(e=i(b+c))&&e.photo;y&&!A[y]&&(e=A[y]=new Image,e.src=y,e.onload=function(){A[y]=!0})}}}function i(a){a=0<a?a%u.length:(100*u.length+a)%u.length;return u[a]}var k=1,g,v,l,j,q,p,m,w,s,n,r,B,z,y={},t={},A={},u=null,E=null,H=!1,F=null,K=null,I=!0,x=0,D=!1;return{save:b,get:c,saveSource:d,getSource:e,clear:function(){removeEvent(window,"orientationchange",f)},open:function(b,d,t,f,g){if(checkEvent(t)||!a())return!0;H=!1;"/rev"==d.substr(-4)&&(d=d.slice(0,-4),H=!0);K=f||null;d?E=d:(d=c(b),E=d.album?"album"+d.album:"");F=qs2obj(nav.params).list?E:"";u=e(E);a:{(d=u)||(d=u);for(var A in d)if(u[A].id==b){x=+A;break a}x=-1}if(-1===x)if(d=c(b),d.id)u=[d],x=0;else return!1;I=2>u.length;b=u[x]&&b!=u[x].id;h(x,g&&!b,b);return!1},prev:function(b){if(checkEvent(b))return!0;if(D&&!i(x-1))return!1;if(!a())return!0;if(I)return photo.close();0>--x&&(x=u.length-1);h(x);return!1},next:function(b){if(checkEvent(b))return!0;if(D&&!i(x+1))return!1;if(!a())return!0;if(I)return!1;++x>=u.length&&(x=0);h(x);return!1},close:function(a){return checkEvent(a)?!0:!1},init:function(a,b,c,d,e,t,f){k="undefined"!==typeof f?f:1;H=!!e;photo.saveSource(a,b,c);onDOMReady(function(){photo.open(d,a+(e?"/rev":""),null,t,!0)})}}}(),audio=function(){function a(){return i[k]||!1}function b(){return a().id||!1}function c(a){a&&(e.src=a.src,e.load(),audio.onSelect(!0,a))}function d(){var a=b();ssSet("audio_id",a);ssSet("audio_pos",0);clog("saved");p&&(document.cookie=p+"="+a+"; expires="+(new Date(vkNow()+864E5)).toUTCString()+"; path="+m)}var e,f=window.Audio?new Audio:ce("audio");f.autobuffer=!0;r=n=w=j=q=f.muted=!1;addEvent(f,"play",function(){l||(l=!0,audio.onPlay(!0),ssSet("audio_play","1"))});addEvent(f,"pause",function(){n?n=!1:l&&(l=!1,audio.onPause(!0),ssSet("audio_play","0"))});addEvent(f,"progress",function(){audio.onProgress(!0)});addEvent(f,"timeupdate",function(){n||(audio.onProgress(!0),audio.onPositionChanged(!0,audio.position(),audio.duration()),ssSet("audio_pos",audio.position()),!q&&0.5>e.duration-e.currentTime&&(q=!0),j&&(j=!1,audio.next()))});addEvent(f,"ended",function(){audio.onEnded(!0);q?(q=!1,audio.next()):j=!0});addEvent(f,"play",B);addEvent(f,"progress canplaythrough",z);addEvent(document,isTouch?"touchstart":"click",y);e=f;var h=Math.random().toString(36).substr(2),i=[],k=null,g={},v="",l=!1,j=!1,q=!1,p=!1,m=!1,w=!1,s=!1,n=!1,r=!1,B=function(a){clog("play after document click");if(w||!1!==r)if(clog("playing: "+(l?"true":"false")),w=!1,!l||!1!==r)n=!0,e.pause(),clog("audio paused after document click");cancelEvent(a);removeEvent(e,"play",B);removeEvent(document,isTouch?"touchstart":"click",y)},z=function(){clog("progress fired, fix_update "+(!r?"not ":"")+"found");!1!==r&&r()},y=function(){s&&(s=!1,clog("document clicked"),w=!0,e.play(),removeEvent(document,isTouch?"touchstart":"click",y))};browser.desktop&&onDOMReady(function(){addClass("volume_reg",bodyNode)});setInterval(function(){var a=lsGet("audio_current_player");h!=a&&l&&audio.pause()},100);return{init:function(a){if(!audio.support)return!1;a.cookie&&(p=a.cookie,m=a.cookie_path||"/");onDOMReady(function(){a.playlist&&audio.playlist(a.playlist,{q:a.playlist_q||""});var b=ssGet("audio_id");if(b){var c=ssGet("audio_pos"),d=ssGet("audio_vol"),e=ssGet("audio_play");audio.select(b);"1"==e&&(null!==c&&audio.position(c),null!==d&&audio.volume(d),s=!0,audio.play());clog(["restored",b,c,d,e].join(", "))}})},support:e.canPlayType&&e.canPlayType("audio/mpeg")&&"no"!=e.canPlayType("audio/mpeg")||!1,onPlay:se(b),onPause:se(b),onDeselect:se(b,function(){return audio.duration()}),onSelect:se(),onProgress:se(b,function(){return audio.loaded()},function(){return audio.duration()}),onPositionChanged:se(b),onVolumeChanged:se(b,function(){return e.volume}),onEnded:se(b),onNotFoundError:se(),onEmptyPlaylistError:se(),getCurrent:a,getCurrentId:b,operate:function(a){if(!audio.support)return!1;a&&(!i[k]||a!=i[k].id)?audio.play(a):l?audio.pause():audio.play()},playing:function(){return l},select:function(a){if(!audio.support)return!1;if(a)if(i.length){if(i[g[a]])return b()&&audio.onDeselect(!0),k=g[a],c(i[k]),d(),!0;audio.onNotFoundError(!0,a)}else audio.onEmptyPlaylistError(!0,a)},play:function(a){if(!audio.support)return!1;if(a){l&&audio.pause();if(!audio.select(a))return;try{e.currentTime=0.01}catch(b){}}l||(e.muted=!1,e.play(),l=!0,audio.onPlay(!0),ssSet("audio_play","1"),lsSet("audio_current_player",h))},pause:function(){if(!audio.support)return!1;l&&(e.pause(),l=!1,audio.onPause(!0),ssSet("audio_play","0"))},position:function(a,b){if(!audio.support)return!1;if("undefined"!==typeof a){b&&(a*=audio.duration());var a=Math.max(0,Math.min(a,audio.duration())),c=l;clog("fix_update: "+r);c&&(l=!1,e.pause());try{e.currentTime=a,audio.onPositionChanged(!0,audio.position(),audio.duration()),ssSet("audio_pos",a),c&&(l=!0,e.muted=!1,e.play())}catch(d){audio.onPositionChanged(!0,a,audio.duration()),clog("need to set position"),r=function(){clog("set position");r=!1;clog("pos: "+a+", playing: "+l);audio.position(a);clog("p.currentTime: "+e.currentTime)},c&&(l=!0)}}else return e.currentTime},volume:function(a){if(!audio.support)return!1;if("undefined"!==typeof a){try{e.volume=a||0}catch(b){}audio.onVolumeChanged(!0);ssSet("audio_vol",a||0)}else return e.volume},loaded:function(){return e.buffered&&e.buffered.length&&e.buffered.end(e.buffered.length-1)||0},duration:function(){return i[k]&&i[k].dur||e.duration||0},next:function(){if(!audio.support)return!1;l&&audio.pause();audio.onDeselect(!0);++k>=i.length&&(k=0);c(i[k]);d();s=!0;audio.play()},prev:function(){if(!audio.support)return!1;l&&audio.pause();audio.onDeselect(!0);0>=--k&&(k=i.length-1);c(i[k]);d();s=!0;audio.play()},playlist:function(b,c){if(!audio.support)return!1;if("undefined"!==typeof b){l&&audio.pause();if(a())audio.onDeselect(!0);i=b;v=c&&c.q||"";k=null;g={};each(b,function(a,b){g[b.id]=a});var d=v;ssSet("audio_query",d);p&&(document.cookie=p+"q="+encodeURIComponent(d)+"; expires="+(new Date(vkNow()+864E5)).toUTCString()+"; path="+m)}else return i},playlist_q:function(){return v}}}(),audioplayer=function(){function a(a){if(a){show("lm_player");var b=ge("lm_audio");b&&(val(geByClass1("artist",b),a.artist),val(geByClass1("title",b),a.title));if(a=ge("audio"+a.id))i(a,0),k(a,0),h(a,j(0,audio.duration())),g(a,audio.volume()),addClass("audio_current",a)}else hide("lm_player")}function b(a,b){var c=ge("audio"+a);removeClass("playing","lm_audio");c&&(h(c,l(b)),removeClass("playing",c),removeClass("audio_current",c))}function c(a,b,c){if(a=ge("audio"+a))r||k(a,b/c),h(a,audioplayer.getFormatedTime(b,c))}function d(a){var b=gpeByClass("audios_list","audio"+a),c=geByClass("audio",b),d=[],e=!1;each(c,function(b,c){c=v(c);if(!c)return!0;d.push(c);c.id==a&&(e=!0)});audio.playlist(d,{q:attr(b,"data-query")});e&&audio.play(a)}function e(a){if(r){var b=gpeByClass("audio",r),c=f(r,a);a&&cancelEvent(a);z&&k(b,c);y&&(g(b,c),audio.volume(c));B=c}}function f(a,b){var c=hasClass("touch",bodyNode)?10:8,d=(b.pageX||b.touches&&b.touches[0]&&b.touches[0].pageX||0)-getX(a)-c/2;return(c=a.offsetWidth-c)?Math.max(0,Math.min(d/c,1)):0}function h(a,b){if(a){var c=geByClass1("dur",a);val(c,b)}}function i(a,b){if(a){var c=geByClass1("progress_wrap",a);geByClass1("load_line",c).style.width=100*Math.max(0,Math.min(b,1))+"%"}}function k(a,b){if(a){var c=geByClass1("progress_wrap",a),c=geByClass1("progress_line",c);geByClass1("slider",c);c.style.width=100*b+"%"}}function g(a,b){if(a){var c=geByClass1("volume_wrap",a),c=geByClass1("progress_line",c);geByClass1("slider",c);c.style.width=100*b+"%"}}function v(a){a=ge(a);if(!a||!attr(a,"data-id")||hasClass("deleted",a))return!1;var b=attr(a,"data-id"),c=val(geByTag1("input",a)),d=attr(geByClass1("dur",a),"data-dur"),e=val(geByClass1("artist",a)),f=val(geByClass1("title",a)),g=!!geByClass1("add",a),a=!!geByClass1("del",a);return{id:b,src:c,dur:d,artist:htsc(stripTags(e)),title:htsc(stripTags(f)),can_add:g,can_del:a}}function l(a){var b,c,d=0>a,a=Math.round(d?-a:a);b=a%60;a=Math.floor(a/60);c=a%60;b=c+":"+(10>b?"0"+b:b);a=Math.floor(a/60);0<a&&(10>c&&(b="0"+b),b=a+":"+b);d&&(b="-"+b);return b}function j(a,b){return l(m&&b?a-b:a)}function q(a){cur.deletedAudios||(cur.deletedAudios={});cur.deletedAudios[a]=!0}function p(a){cur.deletedAudios&&delete cur.deletedAudios[a]}var m="1"==lsGet("audio_time_left"),w="",s="",n="";audio.onPlay(function(a){addClass("playing","lm_audio");if(a=ge("audio"+a))addClass("playing",a),addClass("audio_current",a)});audio.onPause(function(a){removeClass("playing","lm_audio");if(a=ge("audio"+a))removeClass("playing",a),addClass("audio_current",a)});audio.onSelect(a);audio.onDeselect(b);audio.onProgress(function(a,b,c){a=ge("audio"+a);audio.playing()?(addClass("playing",a),addClass("playing","lm_audio")):(removeClass("playing",a),removeClass("playing","lm_audio"));a&&(i(a,b/c),addClass("audio_current",a))});audio.onPositionChanged(c);audio.onVolumeChanged(function(a,b){var c=ge("audio"+a);c&&g(c,b)});audio.onEnded(function(a){(a=ge("audio"+a))&&k(a,1)});audio.onNotFoundError(d);audio.onEmptyPlaylistError(d);var r=null,B=null,z=!1,y=!1;addEvent(document,isTouch?"touchend touchcancel":"mouseup",function(a){if(r){var b=gpeByClass("audio",r),c=f(r,a)||B;a&&cancelEvent(a);z&&(k(b,c),audio.position(c,!0));y&&g(b,c);r=B=null;z=y=!1}});addEvent(document,isTouch?"touchmove":"mousemove",e);return{init:function(a){if(!audio.support)return!1;w=a.add_hash||"";s=a.del_hash||"";n=a.res_hash||""},initAudio:function(){each(geByClass("audio_current"),function(a,c){c=v(c);b(c.id,c.dur)});var d=audio.getCurrentId(),d=ge("audio"+d),e=audio.loaded(),f=audio.position(),g=audio.duration();audio.playing()?(addClass("playing",d),addClass("playing","lm_audio")):(removeClass("playing",d),removeClass("playing","lm_audio"));a(audio.getCurrent());i(d,e/g);c(audio.getCurrentId(),f,g)},getDOMFromAudio:function(a,b,c){if(!a)return"";var d=htsc(a.id),e=htsc(a.src),f=+a.dur,g=a.artist,h=a.title,i=a.can_add,a=a.can_del,k=h?" &ndash; ":"",m=isTouch?"ontouchstart":"onmousedown",j="",n="",p;p=cur.deletedAudios?cur.deletedAudios[d]:!1;if(p){if(c)return"";j+=" deleted"}c=cur.addedAudios?cur.addedAudios[d]:!1;c&&(j+=" added");a?(j+=" have_btn",n='<div class="del" onclick="audioplayer.del(\''+d+"', event);\"><i></i></div>"):i&&(j+=" have_btn",n='<div class="add" onclick="audioplayer.add(\''+d+"', event);\"><i></i></div>");d==audio.getCurrentId()&&(audio.playing()&&(j+=" playing"),j+=" audio_current");return'<div id="audio'+d+'" data-id="'+d+'" class="audio'+j+'" onclick="audioplayer.playPause(\''+d+"'"+(b?", true":"")+');"><div class="audio_info"><div class="play"><i></i></div>'+n+'<div class="audio_cont"><div class="dur" data-dur="'+f+'" onclick="audioplayer.switchTimeFormat(this, event);"><span>'+l(f)+'</span></div><div class="audio_label"><span class="artist">'+g+"</span>"+k+'<span class="title">'+h+'</span></div><input type="hidden" value="'+e+'"></div></div><div class="controls"><table cellspacing="0" cellpadding="0" border="0" width="100%"><tr><td class="line_wrap progress_wrap"><div class="line" '+m+'="audioplayer.setPosition(this, event);" onclick="cancelEvent(event);"><div class="ln back_line" onclick="cancelEvent(event);"></div><div class="ln load_line" onclick="cancelEvent(event);"></div><div class="ln progress_line_wrap" onclick="cancelEvent(event);"><div class="ln progress_line" onclick="cancelEvent(event);"><div class="slider" onclick="cancelEvent(event);"></div></div></div></div></td><td class="line_wrap volume_wrap"><div class="line" '+m+'="audioplayer.setVolume(this, event);" onclick="cancelEvent(event);"><div class="ln back_line" onclick="cancelEvent(event);"></div><div class="ln progress_line_wrap" onclick="cancelEvent(event);"><div class="ln progress_line" onclick="cancelEvent(event);"><div class="slider" onclick="cancelEvent(event);"></div></div></div></div></td></tr></table></div></div>'},add:function(a,b){audio.support&&!hasClass("added","audio"+a)&&(addClass("added","audio"+a),cur.addedAudios||(cur.addedAudios={}),cur.addedAudios[a]=!0,ajax.post("/audio",{_ajax:1,act:"add",audio:a,hash:w},{onDone:function(b){b||(removeClass("added","audio"+a),cur.addedAudios&&delete cur.addedAudios[a])},onFail:function(){removeClass("added","audio"+a);cur.addedAudios&&delete cur.addedAudios[a];switch(Array.prototype.slice.call(arguments).shift()){case 2:nav.go("/audio?act=add&audio="+a+"&hash="+w)}}}),b&&cancelEvent(b))},del:function(a,b){if(audio.support&&ge("audio"+a)){var c=hasClass("deleted","audio"+a);toggleClass("deleted","audio"+a,!c);c?p(a):q(a);ajax.post("/audio",{_ajax:1,act:c?"restore":"delete",audio:a,hash:c?n:s},{onDone:function(b){b||(toggleClass("deleted","audio"+a,c),c?q(a):p(a))},onFail:function(){toggleClass("deleted","audio"+a,c);c?q(a):p(a);switch(Array.prototype.slice.call(arguments).shift()){case 2:nav.go("/audio?act="+(c?"restore":"delete")+"&audio="+a+"&hash="+(c?n:s))}}});b&&cancelEvent(b)}},playPause:function(a,b){if(audio.support){var c=ge("audio"+a);if(!c||!hasClass("deleted",c))b&&a!=audio.getCurrentId()?d(a,!0):audio.operate(a)}else alert(lang.mobile_audio_player_not_support)},getFormatedTime:j,switchTimeFormat:function(a,b){if(hasClass("audio_current",gpeByClass("audio",a))){m=!m;lsSet("audio_time_left",m?"1":"0");var c=ge("audio"+audio.getCurrentId());h(c,j(audio.position(),audio.duration()));b&&cancelEvent(b)}},setPosition:function(a,b){r||(r=a,z=!0,e(b))},setVolume:function(a,b){r||(r=a,y=!0,e(b))},openPlayer:function(a,b){var c=nav.path,d=nav.params,e=c+(d?"?"+d:"")+"#player";return nav.al_go(e,null,{local:!0,target:a,nav:{push:e,path:c,params:d,hash:"#player"},no_push:b})}}}();